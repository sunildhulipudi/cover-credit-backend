<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard ‚Äî Cover Credit</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --primary:#1a3c5e; --primary-dark:#0f2440;
      --accent:#e8622a;  --accent-hover:#c94f1a;
      --bg:#f8f6f1;      --white:#fff;
      --text:#1c1c1c;    --muted:#6b6b6b;
      --border:#e5e0d8;
      --green:#2da44e;   --red:#cf4343;  --orange:#e07b00;
      --blue:#0969da;    --purple:#7c3aed;
      --sidebar:248px;
    }
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);}
    a{text-decoration:none;color:inherit;}

    /* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
    .login-screen{
      display:flex;align-items:center;justify-content:center;
      min-height:100vh;background:linear-gradient(135deg,var(--primary),var(--primary-dark));
    }
    .login-box{
      background:var(--white);border-radius:16px;padding:2.5rem;
      width:100%;max-width:400px;box-shadow:0 24px 60px rgba(0,0,0,.2);
    }
    .login-logo{font-family:'Playfair Display',serif;font-size:1.8rem;color:var(--primary);margin-bottom:.3rem;}
    .login-logo span{color:var(--accent);}
    .login-sub{font-size:.84rem;color:var(--muted);margin-bottom:2rem;}
    .login-box label{display:block;font-size:.82rem;font-weight:600;color:var(--primary);margin-bottom:.4rem;}
    .login-box input{width:100%;padding:.75rem 1rem;border:1.5px solid var(--border);
      border-radius:8px;font-family:inherit;font-size:.92rem;margin-bottom:1rem;outline:none;transition:border-color .2s;}
    .login-box input:focus{border-color:var(--accent);}
    .login-btn{width:100%;padding:.85rem;background:var(--accent);color:var(--white);
      border:none;border-radius:8px;font-family:inherit;font-size:1rem;font-weight:700;cursor:pointer;transition:background .2s;}
    .login-btn:hover{background:var(--accent-hover);}
    .login-error{display:none;background:#fdf0f0;border:1px solid #f5c6c6;border-radius:6px;
      padding:.7rem 1rem;color:var(--red);font-size:.85rem;margin-top:.8rem;}

    /* ‚îÄ‚îÄ APP SHELL ‚îÄ‚îÄ */
    .app{display:none;}
    .app.show{display:flex;min-height:100vh;}

    /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
    .sidebar{
      width:var(--sidebar);background:var(--primary-dark);color:var(--white);
      display:flex;flex-direction:column;position:fixed;top:0;left:0;height:100vh;z-index:100;
    }
    .sidebar-logo{padding:1.5rem 1.4rem;border-bottom:1px solid rgba(255,255,255,.1);
      font-family:'Playfair Display',serif;font-size:1.3rem;}
    .sidebar-logo span{color:var(--accent);}
    .sidebar-nav{flex:1;padding:1rem 0;overflow-y:auto;}
    .nav-section{padding:.4rem 1.4rem .2rem;font-size:.6rem;font-weight:700;
      text-transform:uppercase;letter-spacing:1.5px;color:rgba(255,255,255,.25);margin-top:.6rem;}
    .nav-item{
      display:flex;align-items:center;gap:.7rem;padding:.72rem 1.4rem;
      font-size:.87rem;font-weight:500;color:rgba(255,255,255,.6);
      cursor:pointer;transition:background .18s,color .18s;border:none;background:none;width:100%;text-align:left;
    }
    .nav-item:hover,.nav-item.active{background:rgba(255,255,255,.08);color:var(--white);}
    .nav-item.active{border-left:3px solid var(--accent);}
    .nav-icon{font-size:.95rem;flex-shrink:0;width:18px;text-align:center;}
    .nav-badge{margin-left:auto;background:var(--accent);color:#fff;font-size:.65rem;
      padding:.1rem .42rem;border-radius:100px;font-weight:700;}
    .sidebar-bottom{padding:1rem 1.4rem;border-top:1px solid rgba(255,255,255,.1);}
    .logout-btn{display:flex;align-items:center;gap:.5rem;font-size:.84rem;
      color:rgba(255,255,255,.45);cursor:pointer;background:none;border:none;font-family:inherit;padding:0;transition:color .2s;}
    .logout-btn:hover{color:#f5a07a;}

    /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
    .main{margin-left:var(--sidebar);flex:1;display:flex;flex-direction:column;min-width:0;}
    .topbar{
      background:var(--white);border-bottom:1px solid var(--border);
      padding:1rem 2rem;display:flex;align-items:center;justify-content:space-between;
      position:sticky;top:0;z-index:50;
    }
    .topbar-title{font-family:'Playfair Display',serif;font-size:1.3rem;color:var(--primary);}
    .topbar-right{display:flex;align-items:center;gap:1rem;}
    .topbar-time{font-size:.8rem;color:var(--muted);}
    .content{padding:1.8rem 2rem;}

    /* ‚îÄ‚îÄ STAT CARDS ‚îÄ‚îÄ */
    .stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:1.1rem;margin-bottom:2rem;}
    .stat-card{background:var(--white);border:1px solid var(--border);border-radius:12px;padding:1.3rem;position:relative;overflow:hidden;}
    .stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--accent);}
    .stat-card.green::before{background:var(--green);}
    .stat-card.orange::before{background:var(--orange);}
    .stat-card.blue::before{background:var(--blue);}
    .stat-card.purple::before{background:var(--purple);}
    .stat-label{font-size:.72rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:.45rem;}
    .stat-num{font-family:'Playfair Display',serif;font-size:2.1rem;font-weight:700;color:var(--primary);line-height:1;}
    .stat-sub{font-size:.72rem;color:var(--muted);margin-top:.28rem;}

    /* ‚îÄ‚îÄ DEPT BREAKDOWN ‚îÄ‚îÄ */
    .dept-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:.7rem;margin-bottom:2rem;}
    .dept-tile{background:var(--white);border:1px solid var(--border);border-radius:10px;padding:.9rem 1rem;display:flex;align-items:center;gap:.7rem;}
    .dept-tile-ico{font-size:1.2rem;}
    .dept-tile-body{min-width:0;}
    .dept-tile-count{font-family:'Playfair Display',serif;font-size:1.4rem;color:var(--primary);font-weight:700;line-height:1;}
    .dept-tile-lbl{font-size:.65rem;color:var(--muted);margin-top:.1rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

    /* ‚îÄ‚îÄ PANELS ‚îÄ‚îÄ */
    .panel{display:none;}
    .panel.active{display:block;}
    .panel-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.4rem;flex-wrap:wrap;gap:1rem;}
    .panel-title{font-family:'Playfair Display',serif;font-size:1.4rem;color:var(--primary);}

    /* ‚îÄ‚îÄ CONTROLS ‚îÄ‚îÄ */
    .controls{display:flex;gap:.7rem;flex-wrap:wrap;align-items:center;}
    .search-input{padding:.58rem 1rem;border:1.5px solid var(--border);border-radius:8px;
      font-family:inherit;font-size:.87rem;outline:none;min-width:210px;transition:border-color .2s;}
    .search-input:focus{border-color:var(--accent);}
    .filter-select{padding:.58rem .9rem;border:1.5px solid var(--border);border-radius:8px;
      font-family:inherit;font-size:.87rem;outline:none;background:var(--white);cursor:pointer;}

    /* ‚îÄ‚îÄ PRIMARY BUTTON ‚îÄ‚îÄ */
    .btn-primary{background:var(--accent);color:var(--white);border:none;padding:.58rem 1.2rem;
      border-radius:8px;font-family:inherit;font-size:.87rem;font-weight:700;cursor:pointer;
      display:inline-flex;align-items:center;gap:.4rem;transition:background .2s,transform .15s;}
    .btn-primary:hover{background:var(--accent-hover);transform:translateY(-1px);}

    /* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
    .table-wrap{background:var(--white);border:1px solid var(--border);border-radius:12px;overflow:hidden;overflow-x:auto;}
    table{width:100%;border-collapse:collapse;min-width:700px;}
    thead th{background:var(--primary);color:var(--white);padding:.85rem 1rem;text-align:left;
      font-size:.73rem;font-weight:700;letter-spacing:.5px;text-transform:uppercase;white-space:nowrap;}
    tbody tr{transition:background .15s;}
    tbody tr:hover{background:#faf8f5;}
    tbody td{padding:.82rem 1rem;font-size:.85rem;border-bottom:1px solid var(--border);vertical-align:middle;}
    tbody tr:last-child td{border-bottom:none;}
    .td-name{font-weight:700;color:var(--primary);}
    .td-phone a{color:var(--accent);font-weight:600;}
    .td-date{color:var(--muted);font-size:.76rem;white-space:nowrap;}
    .td-city{font-size:.8rem;color:var(--muted);}

    .dept-badge{display:inline-flex;align-items:center;gap:.3rem;padding:.2rem .6rem;
      border-radius:6px;font-size:.72rem;font-weight:700;white-space:nowrap;}
    .dept-loan{background:#fff8e8;color:#c77f00;}
    .dept-health{background:#fef0f0;color:#c0392b;}
    .dept-life{background:#fef0f8;color:#9b2c7a;}
    .dept-bike{background:#e8f4fd;color:#0969da;}
    .dept-car{background:#f0ffe8;color:#2a7a1e;}
    .dept-commercial{background:#fff3e0;color:#e65100;}

    .badge{display:inline-block;padding:.2rem .58rem;border-radius:100px;font-size:.7rem;
      font-weight:700;text-transform:uppercase;letter-spacing:.4px;}
    .badge-new{background:#fff3e8;color:#e07b00;}
    .badge-contacted{background:#e8f4fd;color:#0969da;}
    .badge-converted{background:#edf8f1;color:var(--green);}
    .badge-closed{background:#f5f5f5;color:var(--muted);}
    .badge-confirmed{background:#e8f4fd;color:#0969da;}
    .badge-completed{background:#edf8f1;color:var(--green);}
    .badge-cancelled{background:#fdf0f0;color:var(--red);}
    .badge-noshow{background:#fff0f0;color:var(--red);}
    .badge-draft{background:#f5f5f5;color:var(--muted);}
    .badge-published{background:#edf8f1;color:var(--green);}
    .badge-expired{background:#fdf0f0;color:var(--red);}

    .cm-chip{font-size:.75rem;color:var(--muted);}

    .actions{display:flex;gap:.35rem;flex-wrap:nowrap;}
    .act-btn{padding:.28rem .58rem;border-radius:5px;font-size:.73rem;font-weight:600;
      cursor:pointer;border:none;font-family:inherit;transition:opacity .2s;white-space:nowrap;}
    .act-btn:hover{opacity:.75;}
    .act-edit{background:#e8f4fd;color:#0969da;}
    .act-delete{background:#fdf0f0;color:var(--red);}
    .act-call{background:#edf8f1;color:var(--green);}
    .act-wa{background:#e8fdf0;color:#128c53;}
    .act-reminder{background:#f3e8ff;color:var(--purple);}
    .act-reminder.is-set{background:var(--purple);color:#fff;}
    .act-publish{background:#edf8f1;color:var(--green);}
    .act-draft{background:#f5f5f5;color:var(--muted);}
    .act-view{background:#fff3e8;color:var(--orange);}

    /* ‚îÄ‚îÄ PAGINATION ‚îÄ‚îÄ */
    .pagination{display:flex;align-items:center;gap:.45rem;margin-top:1.1rem;justify-content:flex-end;flex-wrap:wrap;}
    .page-btn{padding:.38rem .75rem;border:1.5px solid var(--border);border-radius:6px;
      background:var(--white);font-family:inherit;font-size:.83rem;cursor:pointer;transition:background .15s,border-color .15s;}
    .page-btn:hover,.page-btn.active{background:var(--accent);border-color:var(--accent);color:var(--white);}
    .page-info{font-size:.8rem;color:var(--muted);margin-right:.4rem;}

    /* ‚îÄ‚îÄ EDIT MODAL ‚îÄ‚îÄ */
    .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);
      z-index:500;align-items:center;justify-content:center;padding:1rem;}
    .modal-overlay.show{display:flex;}
    .modal{background:var(--white);border-radius:14px;padding:2rem;width:100%;max-width:560px;
      max-height:90vh;overflow-y:auto;box-shadow:0 24px 60px rgba(0,0,0,.2);}
    .modal h3{font-family:'Playfair Display',serif;font-size:1.2rem;color:var(--primary);margin-bottom:1.2rem;}
    .modal-section{margin-bottom:1rem;}
    .modal-section-title{font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;
      color:var(--muted);margin-bottom:.6rem;padding-bottom:.4rem;border-bottom:1px solid var(--border);}
    .modal-info{background:var(--bg);border-radius:8px;padding:1rem;margin-bottom:1rem;}
    .modal-info p{font-size:.84rem;color:var(--text);margin-bottom:.35rem;line-height:1.55;}
    .modal-info p:last-child{margin-bottom:0;}
    .modal-info strong{color:var(--primary);}
    .modal-details{background:#f0ede6;border-radius:8px;padding:1rem;margin-bottom:1rem;}
    .modal-details p{font-size:.82rem;color:var(--text);margin-bottom:.3rem;line-height:1.5;}
    .modal-details p:last-child{margin-bottom:0;}
    .modal label{display:block;font-size:.82rem;font-weight:600;color:var(--primary);
      margin-bottom:.3rem;margin-top:.9rem;}
    .modal select,.modal textarea,.modal input[type="datetime-local"],.modal input[type="text"],
    .modal input[type="url"],.modal input[type="date"]{
      width:100%;padding:.65rem .9rem;border:1.5px solid var(--border);border-radius:7px;
      font-family:inherit;font-size:.9rem;outline:none;transition:border-color .2s;background:var(--white);}
    .modal select:focus,.modal textarea:focus,.modal input:focus{border-color:var(--accent);}
    .modal textarea{resize:vertical;min-height:90px;}
    .modal-actions{display:flex;gap:.8rem;margin-top:1.5rem;justify-content:flex-end;}
    .modal-save{background:var(--accent);color:var(--white);border:none;padding:.65rem 1.4rem;
      border-radius:7px;font-family:inherit;font-size:.9rem;font-weight:700;cursor:pointer;transition:background .2s;}
    .modal-save:hover{background:var(--accent-hover);}
    .modal-save:disabled{background:#c0a898;cursor:not-allowed;}
    .modal-cancel{background:var(--bg);color:var(--text);border:1px solid var(--border);
      padding:.65rem 1.4rem;border-radius:7px;font-family:inherit;font-size:.9rem;font-weight:600;cursor:pointer;}

    /* ‚îÄ‚îÄ CALL LOG ‚îÄ‚îÄ */
    .call-log{border:1px solid var(--border);border-radius:8px;overflow:hidden;max-height:220px;overflow-y:auto;margin-top:.3rem;}
    .call-log-empty{padding:1rem;text-align:center;font-size:.82rem;color:var(--muted);background:#fafaf8;}
    .call-log-entry{padding:.8rem 1rem;border-bottom:1px solid var(--border);}
    .call-log-entry:last-child{border-bottom:none;}
    .call-log-entry:nth-child(odd){background:#fdfcfb;}
    .call-log-text{font-size:.86rem;color:var(--text);line-height:1.55;white-space:pre-wrap;}
    .call-log-meta{font-size:.7rem;color:var(--muted);margin-top:.3rem;}
    .call-log-latest{font-size:.65rem;font-weight:700;color:var(--green);margin-left:.4rem;text-transform:uppercase;letter-spacing:.5px;}

    .note-add-wrap{background:#f0f6ff;border:1.5px solid #c5daf5;border-radius:8px;padding:.9rem 1rem;margin-top:.6rem;}
    .note-add-label{font-size:.72rem;font-weight:700;color:#0969da;text-transform:uppercase;letter-spacing:.8px;margin-bottom:.5rem;}
    .note-add-wrap textarea{min-height:72px;}
    .note-save-btn{margin-top:.5rem;background:#0969da;color:#fff;border:none;padding:.5rem 1.1rem;
      border-radius:6px;font-family:inherit;font-size:.84rem;font-weight:700;cursor:pointer;transition:background .2s;}
    .note-save-btn:hover{background:#0757b5;}
    .note-save-btn:disabled{background:#9ab5d6;cursor:not-allowed;}

    /* ‚îÄ‚îÄ REMINDER MODAL ‚îÄ‚îÄ */
    .reminder-modal{background:var(--white);border-radius:14px;padding:2rem;width:100%;max-width:460px;box-shadow:0 24px 60px rgba(0,0,0,.2);}
    .reminder-modal h3{font-family:'Playfair Display',serif;font-size:1.15rem;color:var(--purple);margin-bottom:.4rem;}
    .reminder-modal-sub{font-size:.8rem;color:var(--muted);margin-bottom:1.2rem;}
    .reminder-customer{background:#f5f0ff;border-radius:8px;padding:.85rem 1rem;margin-bottom:1.1rem;}
    .reminder-customer p{font-size:.84rem;color:var(--text);margin-bottom:.25rem;line-height:1.5;}
    .reminder-customer p:last-child{margin-bottom:0;}
    .reminder-customer strong{color:var(--primary);}
    .reminder-modal label{display:block;font-size:.82rem;font-weight:600;color:var(--primary);margin-bottom:.3rem;margin-top:.9rem;}
    .reminder-modal input[type="datetime-local"],.reminder-modal textarea{
      width:100%;padding:.65rem .9rem;border:1.5px solid var(--border);border-radius:7px;
      font-family:inherit;font-size:.9rem;outline:none;transition:border-color .2s;background:var(--white);}
    .reminder-modal input[type="datetime-local"]:focus,.reminder-modal textarea:focus{border-color:var(--purple);}
    .reminder-modal textarea{resize:vertical;min-height:72px;}
    .reminder-modal-actions{display:flex;gap:.8rem;margin-top:1.5rem;justify-content:flex-end;}
    .reminder-set-btn{background:var(--purple);color:#fff;border:none;padding:.65rem 1.4rem;
      border-radius:7px;font-family:inherit;font-size:.9rem;font-weight:700;cursor:pointer;transition:background .2s;}
    .reminder-set-btn:hover{background:#6d28d9;}
    .reminder-set-btn:disabled{background:#b3a0d4;cursor:not-allowed;}
    .reminder-chip{font-size:.67rem;color:var(--purple);margin-top:.25rem;display:flex;align-items:center;gap:.25rem;}

    /* ‚îÄ‚îÄ BLOG COMPOSE MODAL ‚îÄ‚îÄ */
    .blog-modal{background:var(--white);border-radius:14px;padding:0;width:100%;
      max-width:820px;max-height:92vh;overflow:hidden;display:flex;flex-direction:column;
      box-shadow:0 24px 80px rgba(0,0,0,.25);}
    .blog-modal-head{padding:1.5rem 2rem;border-bottom:1px solid var(--border);
      display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
    .blog-modal-head h3{font-family:'Playfair Display',serif;font-size:1.2rem;color:var(--primary);}
    .blog-modal-close{background:none;border:none;font-size:1.3rem;cursor:pointer;
      color:var(--muted);transition:color .2s;padding:0 .3rem;}
    .blog-modal-close:hover{color:var(--red);}
    .blog-modal-body{flex:1;overflow-y:auto;padding:1.8rem 2rem;}
    .blog-modal-body::-webkit-scrollbar{width:4px;}
    .blog-modal-body::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px;}
    .blog-modal-foot{padding:1rem 2rem;border-top:1px solid var(--border);
      display:flex;align-items:center;justify-content:space-between;flex-shrink:0;gap:1rem;flex-wrap:wrap;}
    .blog-modal-foot-left{font-size:.78rem;color:var(--muted);}
    .blog-modal-foot-right{display:flex;gap:.7rem;}

    /* Two-column grid inside compose form */
    .form-grid-2{display:grid;grid-template-columns:1fr 1fr;gap:1rem;}
    .form-group{display:flex;flex-direction:column;gap:.3rem;}
    .form-group label{font-size:.8rem;font-weight:600;color:var(--primary);}
    .form-group input,.form-group select,.form-group textarea{
      padding:.6rem .9rem;border:1.5px solid var(--border);border-radius:7px;
      font-family:inherit;font-size:.88rem;outline:none;transition:border-color .2s;background:var(--white);}
    .form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:var(--accent);}
    .form-group textarea{resize:vertical;min-height:80px;}
    .form-hint{font-size:.72rem;color:var(--muted);margin-top:.2rem;}
    .form-full{grid-column:1/-1;}

    /* Rich text editor */
    .editor-wrap{border:1.5px solid var(--border);border-radius:7px;overflow:hidden;background:var(--white);}
    .editor-wrap:focus-within{border-color:var(--accent);}
    .editor-toolbar{display:flex;gap:.2rem;padding:.55rem .7rem;background:#f5f3ef;
      border-bottom:1px solid var(--border);flex-wrap:wrap;}
    .editor-btn{padding:.25rem .5rem;background:none;border:1px solid transparent;
      border-radius:4px;font-size:.82rem;cursor:pointer;color:var(--text);
      font-family:inherit;transition:background .15s,border-color .15s;white-space:nowrap;}
    .editor-btn:hover{background:var(--white);border-color:var(--border);}
    .editor-btn.active{background:var(--primary);color:var(--white);border-color:var(--primary);}
    .editor-sep{width:1px;background:var(--border);margin:0 .2rem;align-self:stretch;}
    .editor-area{min-height:260px;max-height:400px;overflow-y:auto;padding:1rem;
      outline:none;font-size:.9rem;line-height:1.8;color:var(--text);}
    .editor-area:empty::before{content:attr(data-placeholder);color:var(--muted);pointer-events:none;}
    .editor-area h2{font-family:'Playfair Display',serif;font-size:1.3rem;color:var(--primary);margin:1rem 0 .4rem;}
    .editor-area h3{font-family:'Playfair Display',serif;font-size:1.1rem;color:var(--primary);margin:.8rem 0 .3rem;}
    .editor-area p{margin-bottom:.7rem;}
    .editor-area ul,.editor-area ol{padding-left:1.4rem;margin-bottom:.7rem;}
    .editor-area li{margin-bottom:.2rem;}
    .editor-area blockquote{border-left:3px solid var(--accent);padding-left:1rem;
      color:var(--muted);font-style:italic;margin:.8rem 0;}
    .editor-area strong{color:var(--primary);}
    .editor-area a{color:var(--accent);}

    /* Cover image preview */
    .cover-preview{margin-top:.5rem;border-radius:8px;overflow:hidden;height:120px;
      background:var(--bg);border:1px solid var(--border);display:none;
      align-items:center;justify-content:center;}
    .cover-preview.show{display:flex;}
    .cover-preview img{width:100%;height:100%;object-fit:cover;}

    /* Category colour dots in blog table */
    .cat-dot{display:inline-flex;align-items:center;gap:.35rem;font-size:.8rem;}
    .cat-dot::before{content:'';width:8px;height:8px;border-radius:50%;flex-shrink:0;}
    .cat-health::before{background:#c0392b;}
    .cat-life::before{background:#9b2c7a;}
    .cat-vehicle::before{background:#0969da;}
    .cat-loans::before{background:#c77f00;}
    .cat-tips::before{background:#e07b00;}
    .cat-news::before{background:var(--green);}
    .cat-guides::before{background:var(--purple);}

    /* Blog stats strip */
    .blog-stats{display:flex;gap:1.5rem;margin-bottom:1.6rem;flex-wrap:wrap;}
    .blog-stat{background:var(--white);border:1px solid var(--border);border-radius:10px;
      padding:.9rem 1.2rem;display:flex;align-items:center;gap:.8rem;}
    .blog-stat-ico{font-size:1.3rem;}
    .blog-stat-num{font-family:'Playfair Display',serif;font-size:1.5rem;color:var(--primary);font-weight:700;line-height:1;}
    .blog-stat-lbl{font-size:.68rem;color:var(--muted);}

    /* ‚îÄ‚îÄ EMPTY ‚îÄ‚îÄ */
    .empty{text-align:center;padding:3rem;color:var(--muted);}
    .empty-icon{font-size:3rem;margin-bottom:.8rem;}
    .empty p{font-size:.9rem;}

    /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
    .toast{position:fixed;bottom:1.5rem;right:1.5rem;z-index:999;
      background:var(--primary-dark);color:var(--white);padding:.8rem 1.4rem;
      border-radius:8px;font-size:.88rem;font-weight:500;box-shadow:0 8px 24px rgba(0,0,0,.2);
      transform:translateY(100px);opacity:0;transition:.3s ease;max-width:320px;}
    .toast.show{transform:translateY(0);opacity:1;}
    .toast.success{background:#1a6e35;}
    .toast.error{background:var(--red);}
    .toast.info{background:var(--purple);}

    .loading{text-align:center;padding:2rem;color:var(--muted);font-size:.9rem;}

    @media(max-width:768px){
      .sidebar{transform:translateX(-100%);}
      .main{margin-left:0;}
      .content{padding:1rem;}
      .form-grid-2{grid-template-columns:1fr;}
      .blog-modal{max-width:100%;border-radius:0;max-height:100vh;}
    }
  </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê -->
<div class="login-screen" id="login-screen">
  <div class="login-box">
    <div class="login-logo">Cover<span>Credit</span></div>
    <p class="login-sub">Admin Dashboard ‚Äî Sign in to continue</p>
    <label for="l-email">Email</label>
    <input type="email" id="l-email" placeholder="admin@covercredit.in" autocomplete="username"/>
    <label for="l-pass">Password</label>
    <input type="password" id="l-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"/>
    <button class="login-btn" onclick="doLogin()">Sign In ‚Üí</button>
    <div class="login-error" id="login-error"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê APP ‚ïê‚ïê‚ïê -->
<div class="app" id="app">

  <aside class="sidebar">
    <div class="sidebar-logo">Cover<span>Credit</span></div>
    <nav class="sidebar-nav">
      <button class="nav-item active" onclick="showPanel('dashboard')">
        <span class="nav-icon">üìä</span> Dashboard
      </button>

      <div class="nav-section">Leads</div>
      <button class="nav-item" onclick="showPanel('bookings')">
        <span class="nav-icon">üìÖ</span> Bookings
        <span class="nav-badge" id="nav-booking-badge"></span>
      </button>
      <button class="nav-item" onclick="showPanel('contacts')">
        <span class="nav-icon">üì©</span> Contacts
        <span class="nav-badge" id="nav-contact-badge"></span>
      </button>

      <div class="nav-section">Content</div>
      <button class="nav-item" onclick="showPanel('blog')">
        <span class="nav-icon">‚úçÔ∏è</span> Blog Posts
        <span class="nav-badge" id="nav-blog-badge"></span>
      </button>
    </nav>
    <div class="sidebar-bottom">
      <button class="logout-btn" onclick="doLogout()">üö™ Sign Out</button>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <span class="topbar-title" id="panel-heading">Dashboard</span>
      <div class="topbar-right">
        <span class="topbar-time" id="clock"></span>
      </div>
    </div>

    <div class="content">

      <!-- ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ -->
      <div class="panel active" id="panel-dashboard">
        <div class="stats-row" id="stats-row"><div class="loading">Loading stats‚Ä¶</div></div>
        <p style="font-size:.72rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:1.2px;margin-bottom:.8rem;">Bookings by Department</p>
        <div class="dept-grid" id="dept-grid"><div class="loading">Loading‚Ä¶</div></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;">
          <div>
            <p style="font-family:'Playfair Display',serif;font-size:1.05rem;color:var(--primary);margin-bottom:.9rem;">Recent Bookings</p>
            <div class="table-wrap" id="recent-bookings"><div class="loading">Loading‚Ä¶</div></div>
          </div>
          <div>
            <p style="font-family:'Playfair Display',serif;font-size:1.05rem;color:var(--primary);margin-bottom:.9rem;">Recent Contacts</p>
            <div class="table-wrap" id="recent-contacts"><div class="loading">Loading‚Ä¶</div></div>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ BOOKINGS ‚îÄ‚îÄ -->
      <div class="panel" id="panel-bookings">
        <div class="panel-header">
          <span class="panel-title">Consultation Bookings</span>
          <div class="controls">
            <input class="search-input" id="booking-search" placeholder="Search name, phone, city‚Ä¶" oninput="debounce(loadBookings,400)()"/>
            <select class="filter-select" id="booking-dept" onchange="loadBookings()">
              <option value="all">All Departments</option>
              <option value="loan">üè† Loans</option>
              <option value="health">üè• Health Insurance</option>
              <option value="life">‚ù§Ô∏è Life Insurance</option>
              <option value="bike">üèçÔ∏è Bike Insurance</option>
              <option value="car">üöó Car Insurance</option>
              <option value="commercial">üöõ Commercial Vehicle</option>
            </select>
            <select class="filter-select" id="booking-status" onchange="loadBookings()">
              <option value="all">All Status</option>
              <option value="new">New</option>
              <option value="confirmed">Confirmed</option>
              <option value="completed">Completed</option>
              <option value="cancelled">Cancelled</option>
              <option value="no-show">No Show</option>
            </select>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Name</th><th>Phone</th><th>Department</th><th>City</th>
                <th>Contact Via</th><th>Best Time</th><th>Status</th><th>Date</th><th>Actions</th>
              </tr>
            </thead>
            <tbody id="bookings-body"><tr><td colspan="9"><div class="loading">Loading‚Ä¶</div></td></tr></tbody>
          </table>
        </div>
        <div class="pagination" id="bookings-pagination"></div>
      </div>

      <!-- ‚îÄ‚îÄ CONTACTS ‚îÄ‚îÄ -->
      <div class="panel" id="panel-contacts">
        <div class="panel-header">
          <span class="panel-title">Contact Form Submissions</span>
          <div class="controls">
            <input class="search-input" id="contact-search" placeholder="Search name, phone‚Ä¶" oninput="debounce(loadContacts,400)()"/>
            <select class="filter-select" id="contact-status" onchange="loadContacts()">
              <option value="all">All Status</option>
              <option value="new">New</option>
              <option value="contacted">Contacted</option>
              <option value="converted">Converted</option>
              <option value="closed">Closed</option>
            </select>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr><th>Name</th><th>Phone</th><th>Email</th><th>Interest</th><th>Status</th><th>Date</th><th>Actions</th></tr>
            </thead>
            <tbody id="contacts-body"><tr><td colspan="7"><div class="loading">Loading‚Ä¶</div></td></tr></tbody>
          </table>
        </div>
        <div class="pagination" id="contacts-pagination"></div>
      </div>

      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           ‚îÄ‚îÄ BLOG PANEL ‚îÄ‚îÄ
      ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <div class="panel" id="panel-blog">
        <div class="panel-header">
          <span class="panel-title">Blog Posts</span>
          <div class="controls">
            <input class="search-input" id="blog-search" placeholder="Search posts‚Ä¶" oninput="debounce(loadBlog,400)()"/>
            <select class="filter-select" id="blog-status-filter" onchange="loadBlog()">
              <option value="all">All Status</option>
              <option value="published">Published</option>
              <option value="draft">Draft</option>
            </select>
            <select class="filter-select" id="blog-cat-filter" onchange="loadBlog()">
              <option value="all">All Categories</option>
              <option value="health">üè• Health</option>
              <option value="life">‚ù§Ô∏è Life</option>
              <option value="vehicle">üöó Vehicle</option>
              <option value="loans">üè† Loans</option>
              <option value="tips">üí° Tips</option>
              <option value="news">üì∞ News</option>
              <option value="guides">üìñ Guides</option>
            </select>
            <button class="btn-primary" onclick="openBlogCompose()">‚úçÔ∏è New Post</button>
          </div>
        </div>

        <!-- Blog stats strip -->
        <div class="blog-stats" id="blog-stats">
          <div class="blog-stat"><span class="blog-stat-ico">üìù</span><div><div class="blog-stat-num" id="bst-total">‚Äî</div><div class="blog-stat-lbl">Total Posts</div></div></div>
          <div class="blog-stat"><span class="blog-stat-ico">‚úÖ</span><div><div class="blog-stat-num" id="bst-published">‚Äî</div><div class="blog-stat-lbl">Published</div></div></div>
          <div class="blog-stat"><span class="blog-stat-ico">üìã</span><div><div class="blog-stat-num" id="bst-draft">‚Äî</div><div class="blog-stat-lbl">Drafts</div></div></div>
          <div class="blog-stat"><span class="blog-stat-ico">üëÅ</span><div><div class="blog-stat-num" id="bst-views">‚Äî</div><div class="blog-stat-lbl">Total Views</div></div></div>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Title</th><th>Category</th><th>Author</th>
                <th>Status</th><th>Views</th><th>Published</th><th>Expires</th><th>Actions</th>
              </tr>
            </thead>
            <tbody id="blog-body"><tr><td colspan="8"><div class="loading">Loading‚Ä¶</div></td></tr></tbody>
          </table>
        </div>
        <div class="pagination" id="blog-pagination"></div>
      </div>

    </div><!-- /content -->
  </main>
</div>

<!-- ‚ïê‚ïê‚ïê EDIT MODAL (bookings/contacts) ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
  <div class="modal" id="modal">
    <h3 id="modal-title">Edit Lead</h3>
    <div class="modal-section">
      <div class="modal-section-title">Contact Details</div>
      <div class="modal-info" id="modal-contact-info"></div>
    </div>
    <div class="modal-section" id="modal-details-section" style="display:none;">
      <div class="modal-section-title" id="modal-details-title">Details</div>
      <div class="modal-details" id="modal-details-body"></div>
    </div>
    <div class="modal-section" id="modal-schedule-section" style="display:none;">
      <div class="modal-section-title">Contact Preference</div>
      <div class="modal-info" id="modal-schedule-info"></div>
    </div>
    <label>Status</label>
    <select id="modal-status"></select>
    <label>Scheduled At (optional)</label>
    <input type="datetime-local" id="modal-scheduled"/>
    <div id="modal-callnotes-section" style="display:none;">
      <label style="margin-top:1.1rem;">Call Notes Log</label>
      <div id="modal-call-log" class="call-log"></div>
      <div class="note-add-wrap">
        <div class="note-add-label">üìù Add Note From This Call</div>
        <textarea id="modal-new-note" placeholder="What happened in this call? Outcome, follow-up needed‚Ä¶"></textarea>
        <button class="note-save-btn" id="note-save-btn" onclick="saveNote()">Save Note</button>
      </div>
    </div>
    <div id="modal-adminnotes-section">
      <label>Admin Notes</label>
      <textarea id="modal-notes" placeholder="Add internal notes here‚Ä¶"></textarea>
    </div>
    <div class="modal-actions">
      <button class="modal-cancel" onclick="closeModal()">Cancel</button>
      <button class="modal-save" onclick="saveEdit()">Save Changes</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê REMINDER MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="reminder-overlay" onclick="closeReminderModal(event)">
  <div class="reminder-modal">
    <h3>‚è∞ Set Reminder</h3>
    <p class="reminder-modal-sub">You'll receive an email when it's time to call this customer.</p>
    <div class="reminder-customer" id="reminder-customer-info"></div>
    <label>Reminder Date &amp; Time *</label>
    <input type="datetime-local" id="reminder-datetime"/>
    <div style="font-size:.72rem;color:var(--muted);margin-top:.3rem;">Times are in your local timezone (IST)</div>
    <label>Note to yourself (optional)</label>
    <textarea id="reminder-note" placeholder="e.g. Ask about health plan for 4 members‚Ä¶"></textarea>
    <div class="reminder-modal-actions">
      <button class="modal-cancel" onclick="closeReminderModal()">Cancel</button>
      <button class="reminder-set-btn" id="reminder-set-btn" onclick="setReminder()">‚è∞ Set Reminder</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê BLOG COMPOSE / EDIT MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="blog-overlay" onclick="closeBlogModal(event)">
  <div class="blog-modal" id="blog-modal">

    <div class="blog-modal-head">
      <h3 id="blog-modal-title">‚úçÔ∏è New Blog Post</h3>
      <button class="blog-modal-close" onclick="closeBlogModal()">‚úï</button>
    </div>

    <div class="blog-modal-body">
      <input type="hidden" id="blog-edit-id"/>

      <div class="form-grid-2">
        <!-- Title -->
        <div class="form-group form-full">
          <label>Post Title *</label>
          <input type="text" id="blog-title" placeholder="e.g. Why Every Family Needs ‚Çπ10 Lakh Health Cover"/>
          <span class="form-hint">Slug auto-generated from title</span>
        </div>

        <!-- Category + Author -->
        <div class="form-group">
          <label>Category *</label>
          <select id="blog-category">
            <option value="">Select category‚Ä¶</option>
            <option value="health">üè• Health Insurance</option>
            <option value="life">‚ù§Ô∏è Life Insurance</option>
            <option value="vehicle">üöó Vehicle Insurance</option>
            <option value="loans">üè† Loans & Finance</option>
            <option value="tips">üí° Insurance Tips</option>
            <option value="news">üì∞ Industry News</option>
            <option value="guides">üìñ Guides</option>
          </select>
        </div>
        <div class="form-group">
          <label>Author</label>
          <input type="text" id="blog-author" placeholder="Cover Credit Team"/>
        </div>

        <!-- Excerpt -->
        <div class="form-group form-full">
          <label>Excerpt * <span style="font-weight:400;color:var(--muted);">(shown on blog card ‚Äî max 400 chars)</span></label>
          <textarea id="blog-excerpt" placeholder="One or two sentences summarising the post‚Ä¶" style="min-height:68px;"></textarea>
          <span class="form-hint" id="excerpt-count">0 / 400</span>
        </div>

        <!-- Cover image -->
        <div class="form-group form-full">
          <label>Cover Image URL <span style="font-weight:400;color:var(--muted);">(Unsplash or your CDN link)</span></label>
          <input type="url" id="blog-cover" placeholder="https://images.unsplash.com/‚Ä¶" oninput="previewCover()"/>
          <div class="cover-preview" id="cover-preview">
            <img id="cover-preview-img" src="" alt="Cover preview"/>
          </div>
        </div>

        <!-- Tags -->
        <div class="form-group form-full">
          <label>Tags <span style="font-weight:400;color:var(--muted);">(comma separated)</span></label>
          <input type="text" id="blog-tags" placeholder="health insurance, family, AP"/>
        </div>

        <!-- Content editor -->
        <div class="form-group form-full">
          <label>Content *</label>
          <div class="editor-wrap">
            <div class="editor-toolbar" id="editor-toolbar">
              <button class="editor-btn" onclick="edFmt('bold')" title="Bold"><b>B</b></button>
              <button class="editor-btn" onclick="edFmt('italic')" title="Italic"><i>I</i></button>
              <button class="editor-btn" onclick="edFmt('underline')" title="Underline"><u>U</u></button>
              <div class="editor-sep"></div>
              <button class="editor-btn" onclick="edBlock('h2')" title="Heading 2">H2</button>
              <button class="editor-btn" onclick="edBlock('h3')" title="Heading 3">H3</button>
              <button class="editor-btn" onclick="edBlock('p')" title="Paragraph">P</button>
              <div class="editor-sep"></div>
              <button class="editor-btn" onclick="edFmt('insertUnorderedList')" title="Bullet list">‚Ä¢ List</button>
              <button class="editor-btn" onclick="edFmt('insertOrderedList')" title="Numbered list">1. List</button>
              <div class="editor-sep"></div>
              <button class="editor-btn" onclick="edBlock('blockquote')" title="Blockquote">" Quote</button>
              <button class="editor-btn" onclick="edLink()" title="Link">üîó Link</button>
              <div class="editor-sep"></div>
              <button class="editor-btn" onclick="edFmt('removeFormat')" title="Clear formatting">‚úï Clear</button>
            </div>
            <div class="editor-area" id="blog-content" contenteditable="true"
              data-placeholder="Start writing your article here‚Ä¶"></div>
          </div>
        </div>

        <!-- Status + Publish date + Expiry -->
        <div class="form-group">
          <label>Status</label>
          <select id="blog-status">
            <option value="draft">üìã Draft ‚Äî not visible on site</option>
            <option value="published">‚úÖ Published ‚Äî live on site</option>
          </select>
        </div>
        <div class="form-group">
          <label>Expiry Date <span style="font-weight:400;color:var(--muted);">(optional)</span></label>
          <input type="date" id="blog-expiry"/>
          <span class="form-hint">Leave blank = never expires</span>
        </div>
      </div>
    </div>

    <div class="blog-modal-foot">
      <div class="blog-modal-foot-left" id="blog-save-status"></div>
      <div class="blog-modal-foot-right">
        <button class="modal-cancel" onclick="closeBlogModal()">Cancel</button>
        <button class="modal-save" id="blog-save-btn" onclick="saveBlogPost()">
          Publish Post
        </button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ Config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const API = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
  ? 'http://localhost:5000/api'
  : '/api';

const DEPT = {
  loan:       { label:'Loans & Finance',            icon:'üè†', cls:'dept-loan'       },
  health:     { label:'Health Insurance',            icon:'üè•', cls:'dept-health'     },
  life:       { label:'Life Insurance',              icon:'‚ù§Ô∏è', cls:'dept-life'       },
  bike:       { label:'Bike Insurance',              icon:'üèçÔ∏è', cls:'dept-bike'       },
  car:        { label:'Car Insurance',               icon:'üöó', cls:'dept-car'        },
  commercial: { label:'Commercial Vehicle Insurance',icon:'üöõ', cls:'dept-commercial' },
};

const BLOG_CAT = {
  health:  { label:'Health Insurance', icon:'üè•' },
  life:    { label:'Life Insurance',   icon:'‚ù§Ô∏è' },
  vehicle: { label:'Vehicle',          icon:'üöó' },
  loans:   { label:'Loans & Finance',  icon:'üè†' },
  tips:    { label:'Insurance Tips',   icon:'üí°' },
  news:    { label:'Industry News',    icon:'üì∞' },
  guides:  { label:'Guides',           icon:'üìñ' },
};

const DETAIL_LABELS = {
  loanType:'Loan Type',loanAmount:'Loan Amount',employmentType:'Employment Type',
  monthlyIncome:'Monthly Income',existingLoans:'Existing Loans',
  coverage:'Coverage For',sumInsured:'Sum Insured',existingPolicy:'Existing Policy',
  preExisting:'Pre-existing Conditions',ageGroup:'Age Group',smoker:'Smoker',
  planType:'Plan Type',coverageAmount:'Coverage Amount',dependants:'Dependants',
  regNumber:'Registration No.',makeModel:'Make & Model',year:'Year',
  currentInsurer:'Current Insurer',coverageType:'Coverage Type',addOns:'Add-ons',
  vehicleType:'Vehicle Type',numberOfVehicles:'No. of Vehicles',goodsCarrierType:'Goods Carrier Type',
};

let token       = localStorage.getItem('cc_token') || '';
let editType    = '';
let editId      = '';
let reminderId  = '';
let blogEditId  = '';
let currentPage = { bookings:1, contacts:1, blog:1 };

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('DOMContentLoaded', () => {
  updateClock();
  setInterval(updateClock, 30000);
  if (token) verifyToken();
  const d = new Date();
  d.setDate(d.getDate() + 1); d.setHours(10,0,0,0);
  document.getElementById('reminder-datetime').value =
    new Date(d - d.getTimezoneOffset()*60000).toISOString().slice(0,16);
  document.getElementById('blog-excerpt').addEventListener('input', updateExcerptCount);
  document.getElementById('blog-status').addEventListener('change', updateSaveBtnLabel);
});

function updateClock() {
  document.getElementById('clock').textContent =
    new Date().toLocaleString('en-IN', {
      timeZone:'Asia/Kolkata', weekday:'short', day:'numeric', month:'short', hour:'2-digit', minute:'2-digit',
    });
}

// ‚îÄ‚îÄ Auth ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function verifyToken() {
  try {
    const r = await apiFetch('/auth/verify');
    if (r.success) showApp();
    else { token=''; localStorage.removeItem('cc_token'); }
  } catch { token=''; localStorage.removeItem('cc_token'); }
}

async function doLogin() {
  const email = document.getElementById('l-email').value.trim();
  const pass  = document.getElementById('l-pass').value;
  const errEl = document.getElementById('login-error');
  errEl.style.display = 'none';
  try {
    const r = await apiFetch('/auth/login','POST',{ email, password:pass });
    if (r.success) {
      token = r.token; localStorage.setItem('cc_token', token); showApp();
    } else { errEl.textContent = r.message; errEl.style.display = 'block'; }
  } catch {
    errEl.textContent = 'Login failed. Check your credentials.'; errEl.style.display = 'block';
  }
}

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') { closeModal(); closeReminderModal(); closeBlogModal(); }
  if (e.key === 'Enter' && document.getElementById('login-screen').style.display !== 'none') doLogin();
});

function doLogout() {
  token=''; localStorage.removeItem('cc_token');
  document.getElementById('app').classList.remove('show');
  document.getElementById('login-screen').style.display = 'flex';
}

function showApp() {
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('app').classList.add('show');
  loadDashboard();
}

// ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const panelTitles = {
  dashboard:'Dashboard', bookings:'Consultation Bookings',
  contacts:'Contact Submissions', blog:'Blog Posts',
};

function showPanel(name) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('panel-' + name).classList.add('active');
  // Find matching nav item by onclick attr
  document.querySelectorAll('.nav-item').forEach(n => {
    if (n.getAttribute('onclick')?.includes(`'${name}'`)) n.classList.add('active');
  });
  document.getElementById('panel-heading').textContent = panelTitles[name] || name;
  if (name === 'bookings') loadBookings();
  if (name === 'contacts') loadContacts();
  if (name === 'blog')     loadBlog();
}

// ‚îÄ‚îÄ API helper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function apiFetch(path, method='GET', body=null) {
  const opts = {
    method,
    headers: { 'Content-Type':'application/json', ...(token ? { Authorization:'Bearer '+token } : {}) },
  };
  if (body) opts.body = JSON.stringify(body);
  const res  = await fetch(API + path, opts);
  const data = await res.json();
  if (res.status === 401 || res.status === 403) doLogout();
  return data;
}

// ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadDashboard() {
  const r = await apiFetch('/admin/stats');
  if (!r.success) return;
  const s = r.stats;

  document.getElementById('stats-row').innerHTML = `
    <div class="stat-card">
      <div class="stat-label">Total Leads</div>
      <div class="stat-num">${s.totalLeads}</div>
      <div class="stat-sub">All time</div>
    </div>
    <div class="stat-card orange">
      <div class="stat-label">New Leads</div>
      <div class="stat-num">${s.newLeads}</div>
      <div class="stat-sub">Awaiting contact</div>
    </div>
    <div class="stat-card blue">
      <div class="stat-label">Bookings</div>
      <div class="stat-num">${s.totalBookings}</div>
      <div class="stat-sub">${s.newBookings} new</div>
    </div>
    <div class="stat-card green">
      <div class="stat-label">Contacts</div>
      <div class="stat-num">${s.totalContacts}</div>
      <div class="stat-sub">${s.newContacts} new</div>
    </div>`;

  document.getElementById('nav-booking-badge').textContent = s.newBookings > 0 ? s.newBookings : '';
  document.getElementById('nav-contact-badge').textContent = s.newContacts > 0 ? s.newContacts : '';

  const deptData = {};
  (r.bookingsByDepartment||[]).forEach(d => { deptData[d._id]=d.count; });
  document.getElementById('dept-grid').innerHTML = Object.entries(DEPT).map(([key,d]) => `
    <div class="dept-tile">
      <span class="dept-tile-ico">${d.icon}</span>
      <div class="dept-tile-body">
        <div class="dept-tile-count">${deptData[key]||0}</div>
        <div class="dept-tile-lbl">${d.label}</div>
      </div>
    </div>`).join('');

  document.getElementById('recent-bookings').innerHTML = miniBookingTable(r.recentBookings);
  document.getElementById('recent-contacts').innerHTML = miniContactTable(r.recentContacts);
}

function miniBookingTable(rows) {
  if (!rows?.length) return '<div class="empty"><div class="empty-icon">üì≠</div><p>No bookings yet</p></div>';
  return `<table><thead><tr><th>Name</th><th>Department</th><th>Status</th><th>Date</th></tr></thead><tbody>`+
    rows.map(b => {
      const d = DEPT[b.department]||{icon:'üìã',label:b.department};
      return `<tr>
        <td class="td-name">${esc(b.name)}</td>
        <td><span class="dept-badge ${(DEPT[b.department]||{cls:''}).cls}">${d.icon} ${d.label}</span></td>
        <td><span class="badge badge-${(b.status||'new').replace('-','')}">${b.status||'new'}</span></td>
        <td class="td-date">${fmtDate(b.createdAt)}</td>
      </tr>`;
    }).join('')+'</tbody></table>';
}

function miniContactTable(rows) {
  if (!rows?.length) return '<div class="empty"><div class="empty-icon">üì≠</div><p>No contacts yet</p></div>';
  return `<table><thead><tr><th>Name</th><th>Phone</th><th>Status</th><th>Date</th></tr></thead><tbody>`+
    rows.map(c => `<tr>
      <td class="td-name">${esc(c.firstName)} ${esc(c.lastName)}</td>
      <td><a href="tel:${c.phone}" style="color:var(--accent);font-weight:600;">${c.phone}</a></td>
      <td><span class="badge badge-${c.status||'new'}">${c.status||'new'}</span></td>
      <td class="td-date">${fmtDate(c.createdAt)}</td>
    </tr>`).join('')+'</tbody></table>';
}

// ‚îÄ‚îÄ Bookings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadBookings(page=currentPage.bookings) {
  currentPage.bookings = page;
  const search = document.getElementById('booking-search')?.value||'';
  const status = document.getElementById('booking-status')?.value||'all';
  const dept   = document.getElementById('booking-dept')?.value||'all';
  const r = await apiFetch('/admin/bookings?'+new URLSearchParams({page,limit:15,status,search,department:dept}));
  if (!r.success) return;
  const tbody = document.getElementById('bookings-body');
  if (!r.data.length) {
    tbody.innerHTML = `<tr><td colspan="9"><div class="empty"><div class="empty-icon">üì≠</div><p>No bookings found</p></div></td></tr>`;
    document.getElementById('bookings-pagination').innerHTML=''; return;
  }
  window._bookingMap={};
  r.data.forEach(b => { window._bookingMap[b._id]=b; });
  tbody.innerHTML = r.data.map(b => {
    const d  = DEPT[b.department]||{icon:'üìã',label:b.department,cls:''};
    const cm = {'Phone Call':'üìû','WhatsApp':'üí¨','Email':'üìß'}[b.contactMethod]||'üìû';
    const slot = (b.timeSlot||'').replace(' (9 AM ‚Äì 12 PM)','').replace(' (12 PM ‚Äì 4 PM)','').replace(' (4 PM ‚Äì 7 PM)','');
    const hasRem = b.reminder&&b.reminder.scheduledAt&&!b.reminder.sent;
    const remChip = hasRem
      ? `<div class="reminder-chip">‚è∞ ${fmtDate(b.reminder.scheduledAt)}</div>`
      : (b.reminder&&b.reminder.sent ? `<div class="reminder-chip" style="color:var(--green);">‚úÖ Reminder sent</div>` : '');
    return `<tr>
      <td class="td-name">${esc(b.name)}</td>
      <td class="td-phone"><a href="tel:${b.phone}">${b.phone}</a></td>
      <td><span class="dept-badge ${d.cls}">${d.icon} ${d.label}</span></td>
      <td class="td-city">${esc(b.city||'‚Äî')}</td>
      <td class="cm-chip">${cm} ${esc(b.contactMethod||'Phone Call')}</td>
      <td style="font-size:.8rem;color:var(--muted);">${esc(slot||b.timeSlot||'‚Äî')}</td>
      <td><span class="badge badge-${(b.status||'new').replace('-','')}">${b.status||'new'}</span></td>
      <td class="td-date">${fmtDate(b.createdAt)}</td>
      <td>
        <div class="actions">
          <a href="tel:${b.phone}" class="act-btn act-call">üìû</a>
          <a href="https://wa.me/${b.phone.replace(/\D/g,'')}" target="_blank" class="act-btn act-wa">üí¨</a>
          <button class="act-btn act-edit" onclick="openEditById('booking','${b._id}')">Edit</button>
          <button class="act-btn act-reminder${hasRem?' is-set':''}" onclick="openReminderModal('${b._id}')">‚è∞</button>
          <button class="act-btn act-delete" onclick="deleteLead('booking','${b._id}')">Del</button>
        </div>
        ${remChip}
      </td>
    </tr>`;
  }).join('');
  renderPagination('bookings-pagination', r.pagination, loadBookings);
}

// ‚îÄ‚îÄ Contacts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadContacts(page=currentPage.contacts) {
  currentPage.contacts = page;
  const search = document.getElementById('contact-search')?.value||'';
  const status = document.getElementById('contact-status')?.value||'all';
  const r = await apiFetch('/admin/contacts?'+new URLSearchParams({page,limit:15,status,search}));
  if (!r.success) return;
  const tbody = document.getElementById('contacts-body');
  if (!r.data.length) {
    tbody.innerHTML = `<tr><td colspan="7"><div class="empty"><div class="empty-icon">üì≠</div><p>No contacts found</p></div></td></tr>`;
    document.getElementById('contacts-pagination').innerHTML=''; return;
  }
  window._contactMap={};
  r.data.forEach(c => { window._contactMap[c._id]=c; });
  tbody.innerHTML = r.data.map(c => `
    <tr>
      <td class="td-name">${esc(c.firstName)} ${esc(c.lastName)}</td>
      <td class="td-phone"><a href="tel:${c.phone}">${c.phone}</a></td>
      <td style="font-size:.82rem;">${c.email?`<a href="mailto:${c.email}">${esc(c.email)}</a>`:'‚Äî'}</td>
      <td style="font-size:.82rem;">${esc(c.interest||'‚Äî')}</td>
      <td><span class="badge badge-${c.status||'new'}">${c.status||'new'}</span></td>
      <td class="td-date">${fmtDate(c.createdAt)}</td>
      <td>
        <div class="actions">
          <a href="tel:${c.phone}" class="act-btn act-call">üìû</a>
          <button class="act-btn act-edit" onclick="openEditById('contact','${c._id}')">Edit</button>
          <button class="act-btn act-delete" onclick="deleteLead('contact','${c._id}')">Del</button>
        </div>
      </td>
    </tr>`).join('');
  renderPagination('contacts-pagination', r.pagination, loadContacts);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ BLOG PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadBlog(page=currentPage.blog) {
  currentPage.blog = page;
  const search   = document.getElementById('blog-search')?.value||'';
  const status   = document.getElementById('blog-status-filter')?.value||'all';
  const category = document.getElementById('blog-cat-filter')?.value||'all';
  const r = await apiFetch('/admin/blog?'+new URLSearchParams({page,limit:15,status,category,search}));
  if (!r.success) return;

  // Stats
  const allR = await apiFetch('/admin/blog?limit=200&status=all');
  if (allR.success) {
    const all = allR.data;
    const pub = all.filter(p=>p.status==='published').length;
    const drft= all.filter(p=>p.status==='draft').length;
    const views= all.reduce((s,p)=>s+(p.views||0),0);
    document.getElementById('bst-total').textContent     = all.length;
    document.getElementById('bst-published').textContent = pub;
    document.getElementById('bst-draft').textContent     = drft;
    document.getElementById('bst-views').textContent     = views.toLocaleString();
    document.getElementById('nav-blog-badge').textContent= drft>0?drft:'';
  }

  const tbody = document.getElementById('blog-body');
  if (!r.data.length) {
    tbody.innerHTML = `<tr><td colspan="8"><div class="empty"><div class="empty-icon">‚úçÔ∏è</div><p>No posts yet. Create your first blog post!</p></div></td></tr>`;
    document.getElementById('blog-pagination').innerHTML=''; return;
  }

  window._blogMap={};
  r.data.forEach(p => { window._blogMap[p._id]=p; });

  const now = new Date();
  tbody.innerHTML = r.data.map(p => {
    const cat      = BLOG_CAT[p.category]||{icon:'üìÑ',label:p.category};
    const isExp    = p.expiresAt && new Date(p.expiresAt) <= now;
    const expSoon  = p.expiresAt && !isExp && Math.ceil((new Date(p.expiresAt)-now)/86400000) <= 14;
    const statusBadge = isExp
      ? `<span class="badge badge-expired">Expired</span>`
      : `<span class="badge badge-${p.status}">${p.status}</span>`;
    const expiryCell = p.expiresAt
      ? `<span style="font-size:.75rem;color:${isExp?'var(--red)':expSoon?'var(--orange)':'var(--muted)'};">
           ${isExp?'‚ö†Ô∏è ':expSoon?'‚è∞ ':''}${fmtDateShort(p.expiresAt)}
         </span>`
      : '<span style="font-size:.75rem;color:var(--muted);">‚Äî</span>';

    return `<tr>
      <td>
        <div style="font-weight:700;color:var(--primary);font-size:.87rem;max-width:260px;
          white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${esc(p.title)}">${esc(p.title)}</div>
        <div style="font-size:.7rem;color:var(--muted);margin-top:.15rem;">/${p.slug}</div>
      </td>
      <td><span class="cat-dot cat-${p.category}">${cat.icon} ${cat.label}</span></td>
      <td style="font-size:.8rem;">${esc(p.author||'‚Äî')}</td>
      <td>${statusBadge}</td>
      <td style="font-size:.82rem;color:var(--muted);">${(p.views||0).toLocaleString()}</td>
      <td class="td-date">${p.publishedAt?fmtDate(p.publishedAt):'<span style="color:var(--muted);">Not set</span>'}</td>
      <td>${expiryCell}</td>
      <td>
        <div class="actions">
          <button class="act-btn act-edit" onclick="openBlogEdit('${p._id}')">Edit</button>
          ${p.status==='draft'
            ? `<button class="act-btn act-publish" onclick="quickPublish('${p._id}')">Publish</button>`
            : `<button class="act-btn act-draft"   onclick="quickDraft('${p._id}')">Unpublish</button>`}
          <button class="act-btn act-delete" onclick="deleteBlog('${p._id}')">Del</button>
        </div>
      </td>
    </tr>`;
  }).join('');

  renderPagination('blog-pagination', r.pagination, loadBlog);
}

// ‚îÄ‚îÄ Quick publish / unpublish ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function quickPublish(id) {
  const r = await apiFetch(`/admin/blog/${id}`,'PATCH',{status:'published'});
  if (r.success) { showToast('Published ‚úì','success'); loadBlog(); }
  else showToast(r.message||'Failed','error');
}
async function quickDraft(id) {
  const r = await apiFetch(`/admin/blog/${id}`,'PATCH',{status:'draft'});
  if (r.success) { showToast('Moved to draft','info'); loadBlog(); }
  else showToast(r.message||'Failed','error');
}

// ‚îÄ‚îÄ Delete blog post ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function deleteBlog(id) {
  if (!confirm('Delete this post permanently?')) return;
  const r = await apiFetch(`/admin/blog/${id}`,'DELETE');
  if (r.success) { showToast('Deleted ‚úì','success'); loadBlog(); }
  else showToast('Delete failed','error');
}

// ‚îÄ‚îÄ Open compose (new post) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openBlogCompose() {
  blogEditId = '';
  document.getElementById('blog-edit-id').value = '';
  document.getElementById('blog-modal-title').textContent = '‚úçÔ∏è New Blog Post';
  document.getElementById('blog-title').value   = '';
  document.getElementById('blog-category').value= '';
  document.getElementById('blog-author').value  = 'Cover Credit Team';
  document.getElementById('blog-excerpt').value = '';
  document.getElementById('blog-cover').value   = '';
  document.getElementById('blog-tags').value    = '';
  document.getElementById('blog-status').value  = 'draft';
  document.getElementById('blog-expiry').value  = '';
  document.getElementById('blog-content').innerHTML = '';
  document.getElementById('cover-preview').classList.remove('show');
  document.getElementById('blog-save-status').textContent = '';
  updateExcerptCount();
  updateSaveBtnLabel();
  document.getElementById('blog-overlay').classList.add('show');
  document.body.style.overflow = 'hidden';
  setTimeout(()=>document.getElementById('blog-title').focus(), 100);
}

// ‚îÄ‚îÄ Open edit (existing post) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function openBlogEdit(id) {
  showToast('Loading post‚Ä¶');
  const r = await apiFetch(`/admin/blog/${id}`);
  if (!r.success) { showToast('Could not load post','error'); return; }
  const p = r.data;
  blogEditId = p._id;

  document.getElementById('blog-edit-id').value   = p._id;
  document.getElementById('blog-modal-title').textContent = '‚úèÔ∏è Edit Post';
  document.getElementById('blog-title').value     = p.title||'';
  document.getElementById('blog-category').value  = p.category||'';
  document.getElementById('blog-author').value    = p.author||'Cover Credit Team';
  document.getElementById('blog-excerpt').value   = p.excerpt||'';
  document.getElementById('blog-cover').value     = p.coverImage||'';
  document.getElementById('blog-tags').value      = (p.tags||[]).join(', ');
  document.getElementById('blog-status').value    = p.status||'draft';
  document.getElementById('blog-expiry').value    = p.expiresAt ? new Date(p.expiresAt).toISOString().slice(0,10) : '';
  document.getElementById('blog-content').innerHTML = p.content||'';
  document.getElementById('blog-save-status').textContent = '';
  previewCover();
  updateExcerptCount();
  updateSaveBtnLabel();
  document.getElementById('blog-overlay').classList.add('show');
  document.body.style.overflow = 'hidden';
}

function closeBlogModal(e) {
  if (!e || e.target === document.getElementById('blog-overlay')) {
    document.getElementById('blog-overlay').classList.remove('show');
    document.body.style.overflow = '';
  }
}

// ‚îÄ‚îÄ Save blog post ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function saveBlogPost() {
  const title    = document.getElementById('blog-title').value.trim();
  const category = document.getElementById('blog-category').value;
  const excerpt  = document.getElementById('blog-excerpt').value.trim();
  const content  = document.getElementById('blog-content').innerHTML.trim();

  if (!title)    { showToast('Title is required','error'); document.getElementById('blog-title').focus(); return; }
  if (!category) { showToast('Please select a category','error'); document.getElementById('blog-category').focus(); return; }
  if (!excerpt)  { showToast('Excerpt is required','error'); document.getElementById('blog-excerpt').focus(); return; }
  if (!content || content === '')  { showToast('Content cannot be empty','error'); document.getElementById('blog-content').focus(); return; }

  const expiryVal = document.getElementById('blog-expiry').value;
  const payload = {
    title, category, excerpt, content,
    author:     document.getElementById('blog-author').value.trim() || 'Cover Credit Team',
    coverImage: document.getElementById('blog-cover').value.trim(),
    tags:       document.getElementById('blog-tags').value,
    status:     document.getElementById('blog-status').value,
    expiresAt:  expiryVal ? expiryVal : null,
  };

  const btn = document.getElementById('blog-save-btn');
  const statusEl = document.getElementById('blog-save-status');
  btn.disabled = true; btn.textContent = 'Saving‚Ä¶'; statusEl.textContent = '';

  const isEdit = !!blogEditId;
  const r = isEdit
    ? await apiFetch(`/admin/blog/${blogEditId}`, 'PATCH', payload)
    : await apiFetch('/admin/blog', 'POST', payload);

  btn.disabled = false;
  updateSaveBtnLabel();

  if (r.success) {
    showToast(isEdit ? 'Post updated ‚úì' : 'Post created ‚úì', 'success');
    closeBlogModal();
    loadBlog();
  } else {
    statusEl.textContent = '‚ö†Ô∏è ' + (r.message||'Save failed');
    showToast(r.message||'Save failed','error');
  }
}

// ‚îÄ‚îÄ Rich text editor helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function edFmt(cmd, val=null) {
  document.getElementById('blog-content').focus();
  document.execCommand(cmd, false, val);
}

function edBlock(tag) {
  const editor = document.getElementById('blog-content');
  editor.focus();
  const sel = window.getSelection();
  if (!sel.rangeCount) return;

  const range    = sel.getRangeAt(0);
  const text     = range.toString() || 'Text here';
  const el       = document.createElement(tag);
  el.textContent = text;

  range.deleteContents();
  range.insertNode(el);

  // Move cursor after inserted element
  const newRange = document.createRange();
  newRange.setStartAfter(el);
  newRange.collapse(true);
  sel.removeAllRanges();
  sel.addRange(newRange);
}

function edLink() {
  const url = prompt('Enter URL:', 'https://');
  if (url) edFmt('createLink', url);
}

// ‚îÄ‚îÄ Cover image preview ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function previewCover() {
  const url = document.getElementById('blog-cover').value.trim();
  const prev = document.getElementById('cover-preview');
  const img  = document.getElementById('cover-preview-img');
  if (url) {
    img.src = url;
    prev.classList.add('show');
    img.onerror = () => prev.classList.remove('show');
  } else {
    prev.classList.remove('show');
  }
}

// ‚îÄ‚îÄ Excerpt counter ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateExcerptCount() {
  const len = document.getElementById('blog-excerpt').value.length;
  const el  = document.getElementById('excerpt-count');
  el.textContent = `${len} / 400`;
  el.style.color = len > 380 ? 'var(--red)' : 'var(--muted)';
}

// ‚îÄ‚îÄ Save button label changes with status dropdown ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateSaveBtnLabel() {
  const btn = document.getElementById('blog-save-btn');
  if (!btn) return;
  const status = document.getElementById('blog-status').value;
  btn.textContent = status === 'published' ? 'Publish Post' : 'Save as Draft';
}

// ‚îÄ‚îÄ Pagination ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderPagination(containerId, pagination, loadFn) {
  const el = document.getElementById(containerId);
  if (!el || pagination.pages <= 1) { if(el) el.innerHTML=''; return; }
  let html = `<span class="page-info">Page ${pagination.page} of ${pagination.pages} (${pagination.total} total)</span>`;
  for (let i=1; i<=pagination.pages; i++) {
    html += `<button class="page-btn${i===pagination.page?' active':''}" onclick="(${loadFn.name})(${i})">${i}</button>`;
  }
  el.innerHTML = html;
}

// ‚îÄ‚îÄ Edit Modal (bookings / contacts) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const bookingStatuses = ['new','confirmed','completed','cancelled','no-show'];
const contactStatuses = ['new','contacted','converted','closed'];

async function openEditById(type, id) {
  showToast('Loading‚Ä¶');
  try {
    const path = type==='booking' ? `/admin/bookings?page=1&limit=200&status=all` : `/admin/contacts?page=1&limit=200&status=all`;
    const r = await apiFetch(path);
    if (r.success) { const rec = r.data.find(x=>x._id===id); if(rec){openEdit(type,rec);return;} }
  } catch(e){}
  const cached = type==='booking' ? (window._bookingMap||{})[id] : (window._contactMap||{})[id];
  if (!cached) { showToast('Could not load. Please refresh.','error'); return; }
  openEdit(type, cached);
}

function openEdit(type, data) {
  editType = type; editId = data._id;
  const isBooking = type==='booking';
  document.getElementById('modal-title').textContent = isBooking ? 'üìÖ Edit Booking' : 'üì© Edit Contact';
  const name = isBooking ? data.name : `${data.firstName} ${data.lastName}`;
  document.getElementById('modal-contact-info').innerHTML = `
    <p><strong>Name:</strong> ${esc(name)}</p>
    <p><strong>Phone:</strong> <a href="tel:${data.phone}" style="color:var(--accent);font-weight:700;">${data.phone}</a></p>
    ${data.email?`<p><strong>Email:</strong> <a href="mailto:${data.email}" style="color:var(--accent);">${esc(data.email)}</a></p>`:''}
    ${isBooking?`<p><strong>City:</strong> ${esc(data.city||'‚Äî')}</p>`:''}
    ${!isBooking&&data.interest?`<p><strong>Interest:</strong> ${esc(data.interest)}</p>`:''}
    ${!isBooking&&data.message?`<p><strong>Message:</strong> ${esc(data.message)}</p>`:''}`;

  if (isBooking) {
    const dept = DEPT[data.department]||{label:data.department,icon:'üìã'};
    document.getElementById('modal-details-section').style.display='block';
    document.getElementById('modal-details-title').textContent=`${dept.icon} ${dept.label} ‚Äî Specifics`;
    const details = data.details||{};
    document.getElementById('modal-details-body').innerHTML =
      Object.entries(details).filter(([,v])=>v&&v!=='')
        .map(([k,v])=>`<p><strong>${DETAIL_LABELS[k]||k}:</strong> ${esc(String(v))}</p>`).join('')
      || '<p style="color:var(--muted);font-size:.82rem;">No specific details captured.</p>';
    document.getElementById('modal-schedule-section').style.display='block';
    document.getElementById('modal-schedule-info').innerHTML=`
      <p><strong>Contact Via:</strong> ${esc(data.contactMethod||'Phone Call')}</p>
      <p><strong>Best Time:</strong> ${esc(data.timeSlot||'‚Äî')}</p>
      ${data.notes?`<p><strong>Notes:</strong> ${esc(data.notes)}</p>`:''}`;
    document.getElementById('modal-scheduled').value = data.scheduledAt ? new Date(data.scheduledAt).toISOString().slice(0,16) : '';
    document.getElementById('modal-callnotes-section').style.display='block';
    document.getElementById('modal-adminnotes-section').style.display='none';
    document.getElementById('modal-new-note').value='';
    renderCallLog(data.callNotes||[]);
  } else {
    document.getElementById('modal-details-section').style.display='none';
    document.getElementById('modal-schedule-section').style.display='none';
    document.getElementById('modal-scheduled').value='';
    document.getElementById('modal-callnotes-section').style.display='none';
    document.getElementById('modal-adminnotes-section').style.display='block';
    document.getElementById('modal-notes').value=data.adminNotes||'';
  }
  document.getElementById('modal-status').innerHTML =
    (isBooking?bookingStatuses:contactStatuses)
      .map(s=>`<option value="${s}"${s===data.status?' selected':''}>${s}</option>`).join('');
  document.getElementById('modal-overlay').classList.add('show');
}

function renderCallLog(notes) {
  const log = document.getElementById('modal-call-log');
  if (!notes||notes.length===0) {
    log.innerHTML='<div class="call-log-empty">No call notes yet. Add a note after each call.</div>'; return;
  }
  const sorted = [...notes].sort((a,b)=>new Date(b.addedAt)-new Date(a.addedAt));
  log.innerHTML = sorted.map((n,i)=>`
    <div class="call-log-entry">
      <div class="call-log-text">${esc(n.text)}</div>
      <div class="call-log-meta">üïê ${fmtDate(n.addedAt)}${i===0?'<span class="call-log-latest">Latest</span>':''}</div>
    </div>`).join('');
}

function closeModal(e) {
  if (!e||e.target===document.getElementById('modal-overlay'))
    document.getElementById('modal-overlay').classList.remove('show');
}

async function saveEdit() {
  const status  = document.getElementById('modal-status').value;
  const path    = editType==='booking' ? `/admin/bookings/${editId}` : `/admin/contacts/${editId}`;
  const payload = { status };
  if (editType==='booking') {
    const s = document.getElementById('modal-scheduled').value;
    if (s) payload.scheduledAt = s;
  } else {
    payload.adminNotes = document.getElementById('modal-notes').value;
  }
  const r = await apiFetch(path,'PATCH',payload);
  if (r.success) {
    closeModal(); showToast('Updated ‚úì','success');
    if(editType==='booking') loadBookings(); else loadContacts();
    loadDashboard();
  } else showToast(r.message||'Update failed','error');
}

async function saveNote() {
  const text = document.getElementById('modal-new-note').value.trim();
  if (!text) { showToast('Write something before saving.','error'); return; }
  const btn = document.getElementById('note-save-btn');
  btn.disabled=true; btn.textContent='Saving‚Ä¶';
  const r = await apiFetch(`/admin/bookings/${editId}/note`,'POST',{text});
  btn.disabled=false; btn.textContent='Save Note';
  if (r.success) {
    if (window._bookingMap?.[editId]) window._bookingMap[editId].callNotes=r.data.callNotes;
    renderCallLog(r.data.callNotes||[]);
    document.getElementById('modal-new-note').value='';
    showToast('Note saved ‚úì','success');
    loadBookings();
  } else showToast(r.message||'Failed to save note.','error');
}

// ‚îÄ‚îÄ Reminder Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openReminderModal(bookingId) {
  reminderId = bookingId;
  const b = (window._bookingMap||{})[bookingId];
  if (!b) { showToast('Could not load booking. Refresh and try again.','error'); return; }
  const dept = DEPT[b.department]||{icon:'üìã',label:b.department};
  const hasActive = b.reminder&&b.reminder.scheduledAt&&!b.reminder.sent;
  document.getElementById('reminder-customer-info').innerHTML=`
    <p><strong>${esc(b.name)}</strong> &nbsp;¬∑&nbsp; <a href="tel:${b.phone}" style="color:var(--accent);font-weight:600;">${b.phone}</a></p>
    <p>${dept.icon} ${dept.label} &nbsp;¬∑&nbsp; ${esc(b.city||'‚Äî')}</p>
    ${hasActive?`<p style="color:var(--purple);font-size:.78rem;margin-top:.3rem;">‚è∞ Current: ${fmtDate(b.reminder.scheduledAt)} ‚Äî will be replaced.</p>`:''}`;
  document.getElementById('reminder-note').value = (b.reminder&&b.reminder.note)?b.reminder.note:'';
  if (hasActive) {
    const d=new Date(b.reminder.scheduledAt);
    document.getElementById('reminder-datetime').value=new Date(d-d.getTimezoneOffset()*60000).toISOString().slice(0,16);
  } else {
    const d=new Date(); d.setDate(d.getDate()+1); d.setHours(10,0,0,0);
    document.getElementById('reminder-datetime').value=new Date(d-d.getTimezoneOffset()*60000).toISOString().slice(0,16);
  }
  document.getElementById('reminder-overlay').classList.add('show');
}

function closeReminderModal(e) {
  if (!e||e.target===document.getElementById('reminder-overlay'))
    document.getElementById('reminder-overlay').classList.remove('show');
}

async function setReminder() {
  const dtVal = document.getElementById('reminder-datetime').value;
  const note  = document.getElementById('reminder-note').value.trim();
  if (!dtVal) { showToast('Please pick a date and time.','error'); return; }
  if (new Date(dtVal)<=new Date()) { showToast('Reminder must be a future date and time.','error'); return; }
  const btn = document.getElementById('reminder-set-btn');
  btn.disabled=true; btn.textContent='Setting‚Ä¶';
  const r = await apiFetch(`/admin/bookings/${reminderId}/reminder`,'POST',{ scheduledAt:new Date(dtVal).toISOString(), note });
  btn.disabled=false; btn.textContent='‚è∞ Set Reminder';
  if (r.success) {
    if (window._bookingMap?.[reminderId]) window._bookingMap[reminderId].reminder=r.data.reminder;
    closeReminderModal();
    showToast("Reminder set! You'll get an email when it's due. ‚úì",'info');
    loadBookings();
  } else showToast(r.message||'Failed to set reminder.','error');
}

// ‚îÄ‚îÄ Delete (leads) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function deleteLead(type, id) {
  if (!confirm('Delete this lead? This cannot be undone.')) return;
  const r = await apiFetch(type==='booking'?`/admin/bookings/${id}`:`/admin/contacts/${id}`,'DELETE');
  if (r.success) {
    showToast('Deleted ‚úì','success');
    if(type==='booking') loadBookings(); else loadContacts();
    loadDashboard();
  } else showToast('Delete failed','error');
}

// ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showToast(msg, type='') {
  const t = document.getElementById('toast');
  t.textContent=msg; t.className='toast show '+type;
  setTimeout(()=>t.classList.remove('show'),3200);
}

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fmtDate(iso) {
  if (!iso) return '‚Äî';
  return new Date(iso).toLocaleString('en-IN',{timeZone:'Asia/Kolkata',day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'});
}
function fmtDateShort(iso) {
  if (!iso) return '‚Äî';
  return new Date(iso).toLocaleDateString('en-IN',{timeZone:'Asia/Kolkata',day:'numeric',month:'short',year:'numeric'});
}
function esc(str) {
  return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
function debounce(fn,ms) {
  let timer;
  return (...args)=>{ clearTimeout(timer); timer=setTimeout(()=>fn(...args),ms); };
}
</script>
</body>
</html>
