<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard â€” Cover Credit</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --primary:#1a3c5e; --primary-dark:#0f2440;
      --accent:#e8622a;  --accent-hover:#c94f1a;
      --bg:#f8f6f1;      --white:#fff;
      --text:#1c1c1c;    --muted:#6b6b6b;
      --border:#e5e0d8;
      --green:#2da44e;   --red:#cf4343;  --orange:#e07b00;
      --blue:#0969da;    --purple:#7c3aed;
      --sidebar:248px;
    }
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);}
    a{text-decoration:none;color:inherit;}

    /* â”€â”€ LOGIN â”€â”€ */
    .login-screen{
      display:flex;align-items:center;justify-content:center;
      min-height:100vh;background:linear-gradient(135deg,var(--primary),var(--primary-dark));
    }
    .login-box{
      background:var(--white);border-radius:16px;padding:2.5rem;
      width:100%;max-width:400px;box-shadow:0 24px 60px rgba(0,0,0,.2);
    }
    .login-logo{font-family:'Playfair Display',serif;font-size:1.8rem;
      color:var(--primary);margin-bottom:.3rem;}
    .login-logo span{color:var(--accent);}
    .login-sub{font-size:.84rem;color:var(--muted);margin-bottom:2rem;}
    .login-box label{display:block;font-size:.82rem;font-weight:600;
      color:var(--primary);margin-bottom:.4rem;}
    .login-box input{width:100%;padding:.75rem 1rem;border:1.5px solid var(--border);
      border-radius:8px;font-family:inherit;font-size:.92rem;
      margin-bottom:1rem;outline:none;transition:border-color .2s;}
    .login-box input:focus{border-color:var(--accent);}
    .login-btn{width:100%;padding:.85rem;background:var(--accent);color:var(--white);
      border:none;border-radius:8px;font-family:inherit;font-size:1rem;
      font-weight:700;cursor:pointer;transition:background .2s;}
    .login-btn:hover{background:var(--accent-hover);}
    .login-error{display:none;background:#fdf0f0;border:1px solid #f5c6c6;
      border-radius:6px;padding:.7rem 1rem;color:var(--red);
      font-size:.85rem;margin-top:.8rem;}

    /* â”€â”€ APP SHELL â”€â”€ */
    .app{display:none;}
    .app.show{display:flex;min-height:100vh;}

    /* â”€â”€ SIDEBAR â”€â”€ */
    .sidebar{
      width:var(--sidebar);background:var(--primary-dark);color:var(--white);
      display:flex;flex-direction:column;position:fixed;top:0;left:0;
      height:100vh;z-index:100;
    }
    .sidebar-logo{
      padding:1.5rem 1.4rem;border-bottom:1px solid rgba(255,255,255,.1);
      font-family:'Playfair Display',serif;font-size:1.3rem;
    }
    .sidebar-logo span{color:var(--accent);}
    .sidebar-nav{flex:1;padding:1rem 0;overflow-y:auto;}
    .nav-section{padding:.4rem 1.4rem .2rem;font-size:.6rem;font-weight:700;
      text-transform:uppercase;letter-spacing:1.5px;color:rgba(255,255,255,.25);
      margin-top:.6rem;}
    .nav-item{
      display:flex;align-items:center;gap:.7rem;padding:.72rem 1.4rem;
      font-size:.87rem;font-weight:500;color:rgba(255,255,255,.6);
      cursor:pointer;transition:background .18s,color .18s;border:none;
      background:none;width:100%;text-align:left;
    }
    .nav-item:hover,.nav-item.active{background:rgba(255,255,255,.08);color:var(--white);}
    .nav-item.active{border-left:3px solid var(--accent);}
    .nav-icon{font-size:.95rem;flex-shrink:0;width:18px;text-align:center;}
    .nav-badge{margin-left:auto;background:var(--accent);color:#fff;
      font-size:.65rem;padding:.1rem .42rem;border-radius:100px;font-weight:700;}
    .sidebar-bottom{padding:1rem 1.4rem;border-top:1px solid rgba(255,255,255,.1);}
    .logout-btn{display:flex;align-items:center;gap:.5rem;font-size:.84rem;
      color:rgba(255,255,255,.45);cursor:pointer;background:none;border:none;
      font-family:inherit;padding:0;transition:color .2s;}
    .logout-btn:hover{color:#f5a07a;}

    /* â”€â”€ MAIN â”€â”€ */
    .main{margin-left:var(--sidebar);flex:1;display:flex;flex-direction:column;min-width:0;}
    .topbar{
      background:var(--white);border-bottom:1px solid var(--border);
      padding:1rem 2rem;display:flex;align-items:center;
      justify-content:space-between;position:sticky;top:0;z-index:50;
    }
    .topbar-title{font-family:'Playfair Display',serif;font-size:1.3rem;color:var(--primary);}
    .topbar-right{display:flex;align-items:center;gap:1rem;}
    .topbar-time{font-size:.8rem;color:var(--muted);}
    .content{padding:1.8rem 2rem;}

    /* â”€â”€ STAT CARDS â”€â”€ */
    .stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
      gap:1.1rem;margin-bottom:2rem;}
    .stat-card{background:var(--white);border:1px solid var(--border);
      border-radius:12px;padding:1.3rem;position:relative;overflow:hidden;}
    .stat-card::before{content:'';position:absolute;top:0;left:0;right:0;
      height:3px;background:var(--accent);}
    .stat-card.green::before{background:var(--green);}
    .stat-card.orange::before{background:var(--orange);}
    .stat-card.blue::before{background:var(--blue);}
    .stat-label{font-size:.72rem;font-weight:700;color:var(--muted);
      text-transform:uppercase;letter-spacing:1px;margin-bottom:.45rem;}
    .stat-num{font-family:'Playfair Display',serif;font-size:2.1rem;
      font-weight:700;color:var(--primary);line-height:1;}
    .stat-sub{font-size:.72rem;color:var(--muted);margin-top:.28rem;}

    /* â”€â”€ DEPT BREAKDOWN â”€â”€ */
    .dept-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));
      gap:.7rem;margin-bottom:2rem;}
    .dept-tile{background:var(--white);border:1px solid var(--border);
      border-radius:10px;padding:.9rem 1rem;display:flex;align-items:center;gap:.7rem;}
    .dept-tile-ico{font-size:1.2rem;}
    .dept-tile-body{min-width:0;}
    .dept-tile-count{font-family:'Playfair Display',serif;font-size:1.4rem;
      color:var(--primary);font-weight:700;line-height:1;}
    .dept-tile-lbl{font-size:.65rem;color:var(--muted);margin-top:.1rem;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

    /* â”€â”€ PANELS â”€â”€ */
    .panel{display:none;}
    .panel.active{display:block;}
    .panel-header{
      display:flex;align-items:center;justify-content:space-between;
      margin-bottom:1.4rem;flex-wrap:wrap;gap:1rem;
    }
    .panel-title{font-family:'Playfair Display',serif;font-size:1.4rem;color:var(--primary);}

    /* â”€â”€ CONTROLS â”€â”€ */
    .controls{display:flex;gap:.7rem;flex-wrap:wrap;align-items:center;}
    .search-input{
      padding:.58rem 1rem;border:1.5px solid var(--border);border-radius:8px;
      font-family:inherit;font-size:.87rem;outline:none;min-width:210px;
      transition:border-color .2s;
    }
    .search-input:focus{border-color:var(--accent);}
    .filter-select{
      padding:.58rem .9rem;border:1.5px solid var(--border);border-radius:8px;
      font-family:inherit;font-size:.87rem;outline:none;background:var(--white);cursor:pointer;
    }

    /* â”€â”€ TABLE â”€â”€ */
    .table-wrap{background:var(--white);border:1px solid var(--border);
      border-radius:12px;overflow:hidden;overflow-x:auto;}
    table{width:100%;border-collapse:collapse;min-width:700px;}
    thead th{
      background:var(--primary);color:var(--white);padding:.85rem 1rem;
      text-align:left;font-size:.73rem;font-weight:700;letter-spacing:.5px;
      text-transform:uppercase;white-space:nowrap;
    }
    tbody tr{transition:background .15s;}
    tbody tr:hover{background:#faf8f5;}
    tbody td{padding:.82rem 1rem;font-size:.85rem;border-bottom:1px solid var(--border);
      vertical-align:middle;}
    tbody tr:last-child td{border-bottom:none;}
    .td-name{font-weight:700;color:var(--primary);}
    .td-phone a{color:var(--accent);font-weight:600;}
    .td-date{color:var(--muted);font-size:.76rem;white-space:nowrap;}
    .td-city{font-size:.8rem;color:var(--muted);}

    /* Department badges */
    .dept-badge{
      display:inline-flex;align-items:center;gap:.3rem;padding:.2rem .6rem;
      border-radius:6px;font-size:.72rem;font-weight:700;white-space:nowrap;
    }
    .dept-loan      {background:#fff8e8;color:#c77f00;}
    .dept-health    {background:#fef0f0;color:#c0392b;}
    .dept-life      {background:#fef0f8;color:#9b2c7a;}
    .dept-bike      {background:#e8f4fd;color:#0969da;}
    .dept-car       {background:#f0ffe8;color:#2a7a1e;}
    .dept-commercial{background:#fff3e0;color:#e65100;}

    /* Status badges */
    .badge{display:inline-block;padding:.2rem .58rem;border-radius:100px;
      font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.4px;}
    .badge-new      {background:#fff3e8;color:#e07b00;}
    .badge-contacted{background:#e8f4fd;color:#0969da;}
    .badge-converted{background:#edf8f1;color:var(--green);}
    .badge-closed   {background:#f5f5f5;color:var(--muted);}
    .badge-confirmed{background:#e8f4fd;color:#0969da;}
    .badge-completed{background:#edf8f1;color:var(--green);}
    .badge-cancelled{background:#fdf0f0;color:var(--red);}
    .badge-noshow   {background:#fff0f0;color:var(--red);}

    .cm-chip{font-size:.75rem;color:var(--muted);}

    /* Action buttons */
    .actions{display:flex;gap:.35rem;flex-wrap:nowrap;}
    .act-btn{
      padding:.28rem .58rem;border-radius:5px;font-size:.73rem;
      font-weight:600;cursor:pointer;border:none;font-family:inherit;
      transition:opacity .2s;white-space:nowrap;
    }
    .act-btn:hover{opacity:.75;}
    .act-edit     {background:#e8f4fd;color:#0969da;}
    .act-delete   {background:#fdf0f0;color:var(--red);}
    .act-call     {background:#edf8f1;color:var(--green);}
    .act-wa       {background:#e8fdf0;color:#128c53;}
    /* Reminder button â€” purple, fills solid when a reminder is active */
    .act-reminder         {background:#f3e8ff;color:var(--purple);}
    .act-reminder.is-set  {background:var(--purple);color:#fff;}

    /* â”€â”€ PAGINATION â”€â”€ */
    .pagination{display:flex;align-items:center;gap:.45rem;margin-top:1.1rem;
      justify-content:flex-end;flex-wrap:wrap;}
    .page-btn{
      padding:.38rem .75rem;border:1.5px solid var(--border);border-radius:6px;
      background:var(--white);font-family:inherit;font-size:.83rem;
      cursor:pointer;transition:background .15s,border-color .15s;
    }
    .page-btn:hover,.page-btn.active{background:var(--accent);
      border-color:var(--accent);color:var(--white);}
    .page-info{font-size:.8rem;color:var(--muted);margin-right:.4rem;}

    /* â”€â”€ EDIT MODAL â”€â”€ */
    .modal-overlay{
      display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);
      z-index:500;align-items:center;justify-content:center;padding:1rem;
    }
    .modal-overlay.show{display:flex;}
    .modal{
      background:var(--white);border-radius:14px;padding:2rem;
      width:100%;max-width:560px;max-height:90vh;overflow-y:auto;
      box-shadow:0 24px 60px rgba(0,0,0,.2);
    }
    .modal h3{font-family:'Playfair Display',serif;font-size:1.2rem;
      color:var(--primary);margin-bottom:1.2rem;}
    .modal-section{margin-bottom:1rem;}
    .modal-section-title{font-size:.65rem;font-weight:700;text-transform:uppercase;
      letter-spacing:1.5px;color:var(--muted);margin-bottom:.6rem;
      padding-bottom:.4rem;border-bottom:1px solid var(--border);}
    .modal-info{background:var(--bg);border-radius:8px;padding:1rem;margin-bottom:1rem;}
    .modal-info p{font-size:.84rem;color:var(--text);margin-bottom:.35rem;line-height:1.55;}
    .modal-info p:last-child{margin-bottom:0;}
    .modal-info strong{color:var(--primary);}
    .modal-details{background:#f0ede6;border-radius:8px;padding:1rem;margin-bottom:1rem;}
    .modal-details p{font-size:.82rem;color:var(--text);margin-bottom:.3rem;line-height:1.5;}
    .modal-details p:last-child{margin-bottom:0;}
    .modal label{display:block;font-size:.82rem;font-weight:600;
      color:var(--primary);margin-bottom:.3rem;margin-top:.9rem;}
    .modal select,.modal textarea,.modal input[type="datetime-local"]{
      width:100%;padding:.65rem .9rem;border:1.5px solid var(--border);
      border-radius:7px;font-family:inherit;font-size:.9rem;outline:none;
      transition:border-color .2s;background:var(--white);
    }
    .modal select:focus,.modal textarea:focus,.modal input[type="datetime-local"]:focus{
      border-color:var(--accent);
    }
    .modal textarea{resize:vertical;min-height:90px;}
    .modal-actions{display:flex;gap:.8rem;margin-top:1.5rem;justify-content:flex-end;}
    .modal-save{background:var(--accent);color:var(--white);border:none;
      padding:.65rem 1.4rem;border-radius:7px;font-family:inherit;
      font-size:.9rem;font-weight:700;cursor:pointer;transition:background .2s;}
    .modal-save:hover{background:var(--accent-hover);}
    .modal-cancel{background:var(--bg);color:var(--text);border:1px solid var(--border);
      padding:.65rem 1.4rem;border-radius:7px;font-family:inherit;
      font-size:.9rem;font-weight:600;cursor:pointer;}

    /* â”€â”€ CALL LOG (inside edit modal, bookings only) â”€â”€ */
    .call-log{border:1px solid var(--border);border-radius:8px;overflow:hidden;
      max-height:220px;overflow-y:auto;margin-top:.3rem;}
    .call-log-empty{padding:1rem;text-align:center;font-size:.82rem;color:var(--muted);
      background:#fafaf8;}
    .call-log-entry{padding:.8rem 1rem;border-bottom:1px solid var(--border);}
    .call-log-entry:last-child{border-bottom:none;}
    .call-log-entry:nth-child(odd){background:#fdfcfb;}
    .call-log-text{font-size:.86rem;color:var(--text);line-height:1.55;white-space:pre-wrap;}
    .call-log-meta{font-size:.7rem;color:var(--muted);margin-top:.3rem;}
    .call-log-latest{font-size:.65rem;font-weight:700;color:var(--green);
      margin-left:.4rem;text-transform:uppercase;letter-spacing:.5px;}

    /* Add note area */
    .note-add-wrap{background:#f0f6ff;border:1.5px solid #c5daf5;border-radius:8px;
      padding:.9rem 1rem;margin-top:.6rem;}
    .note-add-label{font-size:.72rem;font-weight:700;color:#0969da;
      text-transform:uppercase;letter-spacing:.8px;margin-bottom:.5rem;}
    .note-add-wrap textarea{min-height:72px;}
    .note-save-btn{margin-top:.5rem;background:#0969da;color:#fff;border:none;
      padding:.5rem 1.1rem;border-radius:6px;font-family:inherit;font-size:.84rem;
      font-weight:700;cursor:pointer;transition:background .2s;}
    .note-save-btn:hover{background:#0757b5;}
    .note-save-btn:disabled{background:#9ab5d6;cursor:not-allowed;}

    /* â”€â”€ REMINDER MODAL â”€â”€ */
    .reminder-modal{
      background:var(--white);border-radius:14px;padding:2rem;
      width:100%;max-width:460px;
      box-shadow:0 24px 60px rgba(0,0,0,.2);
    }
    .reminder-modal h3{font-family:'Playfair Display',serif;font-size:1.15rem;
      color:var(--purple);margin-bottom:.4rem;}
    .reminder-modal-sub{font-size:.8rem;color:var(--muted);margin-bottom:1.2rem;}
    .reminder-customer{background:#f5f0ff;border-radius:8px;padding:.85rem 1rem;
      margin-bottom:1.1rem;}
    .reminder-customer p{font-size:.84rem;color:var(--text);margin-bottom:.25rem;line-height:1.5;}
    .reminder-customer p:last-child{margin-bottom:0;}
    .reminder-customer strong{color:var(--primary);}
    .reminder-modal label{display:block;font-size:.82rem;font-weight:600;
      color:var(--primary);margin-bottom:.3rem;margin-top:.9rem;}
    .reminder-modal input[type="datetime-local"],.reminder-modal textarea{
      width:100%;padding:.65rem .9rem;border:1.5px solid var(--border);
      border-radius:7px;font-family:inherit;font-size:.9rem;outline:none;
      transition:border-color .2s;background:var(--white);
    }
    .reminder-modal input[type="datetime-local"]:focus,
    .reminder-modal textarea:focus{border-color:var(--purple);}
    .reminder-modal textarea{resize:vertical;min-height:72px;}
    .reminder-modal-actions{display:flex;gap:.8rem;margin-top:1.5rem;justify-content:flex-end;}
    .reminder-set-btn{background:var(--purple);color:#fff;border:none;
      padding:.65rem 1.4rem;border-radius:7px;font-family:inherit;
      font-size:.9rem;font-weight:700;cursor:pointer;transition:background .2s;}
    .reminder-set-btn:hover{background:#6d28d9;}
    .reminder-set-btn:disabled{background:#b3a0d4;cursor:not-allowed;}
    /* Small reminder indicator shown under booking row actions */
    .reminder-chip{font-size:.67rem;color:var(--purple);margin-top:.25rem;
      display:flex;align-items:center;gap:.25rem;}

    /* â”€â”€ EMPTY â”€â”€ */
    .empty{text-align:center;padding:3rem;color:var(--muted);}
    .empty-icon{font-size:3rem;margin-bottom:.8rem;}
    .empty p{font-size:.9rem;}

    /* â”€â”€ TOAST â”€â”€ */
    .toast{
      position:fixed;bottom:1.5rem;right:1.5rem;z-index:999;
      background:var(--primary-dark);color:var(--white);
      padding:.8rem 1.4rem;border-radius:8px;font-size:.88rem;
      font-weight:500;box-shadow:0 8px 24px rgba(0,0,0,.2);
      transform:translateY(100px);opacity:0;transition:.3s ease;max-width:320px;
    }
    .toast.show{transform:translateY(0);opacity:1;}
    .toast.success{background:#1a6e35;}
    .toast.error  {background:var(--red);}
    .toast.info   {background:var(--purple);}

    .loading{text-align:center;padding:2rem;color:var(--muted);font-size:.9rem;}

    @media(max-width:768px){
      .sidebar{transform:translateX(-100%);}
      .main{margin-left:0;}
      .content{padding:1rem;}
    }
  </style>
</head>
<body>

<!-- â•â•â• LOGIN â•â•â• -->
<div class="login-screen" id="login-screen">
  <div class="login-box">
    <div class="login-logo">Cover<span>Credit</span></div>
    <p class="login-sub">Admin Dashboard â€” Sign in to continue</p>
    <label for="l-email">Email</label>
    <input type="email" id="l-email" placeholder="admin@covercredit.in" autocomplete="username"/>
    <label for="l-pass">Password</label>
    <input type="password" id="l-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password"/>
    <button class="login-btn" onclick="doLogin()">Sign In â†’</button>
    <div class="login-error" id="login-error"></div>
  </div>
</div>

<!-- â•â•â• APP â•â•â• -->
<div class="app" id="app">

  <aside class="sidebar">
    <div class="sidebar-logo">Cover<span>Credit</span></div>
    <nav class="sidebar-nav">
      <button class="nav-item active" onclick="showPanel('dashboard')">
        <span class="nav-icon">ğŸ“Š</span> Dashboard
      </button>
      <div class="nav-section">Leads</div>
      <button class="nav-item" onclick="showPanel('bookings')">
        <span class="nav-icon">ğŸ“…</span> Bookings
        <span class="nav-badge" id="nav-booking-badge"></span>
      </button>
      <button class="nav-item" onclick="showPanel('contacts')">
        <span class="nav-icon">ğŸ“©</span> Contacts
        <span class="nav-badge" id="nav-contact-badge"></span>
      </button>
    </nav>
    <div class="sidebar-bottom">
      <button class="logout-btn" onclick="doLogout()">ğŸšª Sign Out</button>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <span class="topbar-title" id="panel-heading">Dashboard</span>
      <div class="topbar-right">
        <span class="topbar-time" id="clock"></span>
      </div>
    </div>

    <div class="content">

      <!-- â”€â”€ DASHBOARD â”€â”€ -->
      <div class="panel active" id="panel-dashboard">
        <div class="stats-row" id="stats-row">
          <div class="loading">Loading statsâ€¦</div>
        </div>
        <p style="font-size:.72rem;font-weight:700;color:var(--muted);text-transform:uppercase;
           letter-spacing:1.2px;margin-bottom:.8rem;">Bookings by Department</p>
        <div class="dept-grid" id="dept-grid">
          <div class="loading">Loadingâ€¦</div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;">
          <div>
            <p style="font-family:'Playfair Display',serif;font-size:1.05rem;
               color:var(--primary);margin-bottom:.9rem;">Recent Bookings</p>
            <div class="table-wrap" id="recent-bookings"><div class="loading">Loadingâ€¦</div></div>
          </div>
          <div>
            <p style="font-family:'Playfair Display',serif;font-size:1.05rem;
               color:var(--primary);margin-bottom:.9rem;">Recent Contacts</p>
            <div class="table-wrap" id="recent-contacts"><div class="loading">Loadingâ€¦</div></div>
          </div>
        </div>
      </div>

      <!-- â”€â”€ BOOKINGS â”€â”€ -->
      <div class="panel" id="panel-bookings">
        <div class="panel-header">
          <span class="panel-title">Consultation Bookings</span>
          <div class="controls">
            <input class="search-input" id="booking-search"
              placeholder="Search name, phone, cityâ€¦"
              oninput="debounce(loadBookings,400)()"/>
            <select class="filter-select" id="booking-dept" onchange="loadBookings()">
              <option value="all">All Departments</option>
              <option value="loan">ğŸ  Loans</option>
              <option value="health">ğŸ¥ Health Insurance</option>
              <option value="life">â¤ï¸ Life Insurance</option>
              <option value="bike">ğŸï¸ Bike Insurance</option>
              <option value="car">ğŸš— Car Insurance</option>
              <option value="commercial">ğŸš› Commercial Vehicle</option>
            </select>
            <select class="filter-select" id="booking-status" onchange="loadBookings()">
              <option value="all">All Status</option>
              <option value="new">New</option>
              <option value="confirmed">Confirmed</option>
              <option value="completed">Completed</option>
              <option value="cancelled">Cancelled</option>
              <option value="no-show">No Show</option>
            </select>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Phone</th>
                <th>Department</th>
                <th>City</th>
                <th>Contact Via</th>
                <th>Best Time</th>
                <th>Status</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="bookings-body">
              <tr><td colspan="9"><div class="loading">Loadingâ€¦</div></td></tr>
            </tbody>
          </table>
        </div>
        <div class="pagination" id="bookings-pagination"></div>
      </div>

      <!-- â”€â”€ CONTACTS â”€â”€ -->
      <div class="panel" id="panel-contacts">
        <div class="panel-header">
          <span class="panel-title">Contact Form Submissions</span>
          <div class="controls">
            <input class="search-input" id="contact-search"
              placeholder="Search name, phoneâ€¦"
              oninput="debounce(loadContacts,400)()"/>
            <select class="filter-select" id="contact-status" onchange="loadContacts()">
              <option value="all">All Status</option>
              <option value="new">New</option>
              <option value="contacted">Contacted</option>
              <option value="converted">Converted</option>
              <option value="closed">Closed</option>
            </select>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Name</th><th>Phone</th><th>Email</th>
                <th>Interest</th><th>Status</th><th>Date</th><th>Actions</th>
              </tr>
            </thead>
            <tbody id="contacts-body">
              <tr><td colspan="7"><div class="loading">Loadingâ€¦</div></td></tr>
            </tbody>
          </table>
        </div>
        <div class="pagination" id="contacts-pagination"></div>
      </div>

    </div><!-- /content -->
  </main>
</div>

<!-- â•â•â• EDIT MODAL â•â•â• -->
<div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
  <div class="modal" id="modal">
    <h3 id="modal-title">Edit Lead</h3>

    <!-- Contact info -->
    <div class="modal-section">
      <div class="modal-section-title">Contact Details</div>
      <div class="modal-info" id="modal-contact-info"></div>
    </div>

    <!-- Dept-specific details (bookings only) -->
    <div class="modal-section" id="modal-details-section" style="display:none;">
      <div class="modal-section-title" id="modal-details-title">Details</div>
      <div class="modal-details" id="modal-details-body"></div>
    </div>

    <!-- Schedule (bookings only) -->
    <div class="modal-section" id="modal-schedule-section" style="display:none;">
      <div class="modal-section-title">Contact Preference</div>
      <div class="modal-info" id="modal-schedule-info"></div>
    </div>

    <label>Status</label>
    <select id="modal-status"></select>

    <label>Scheduled At (optional)</label>
    <input type="datetime-local" id="modal-scheduled"/>

    <!-- â”€â”€ CALL NOTES LOG (bookings only) â”€â”€ -->
    <div id="modal-callnotes-section" style="display:none;">
      <label style="margin-top:1.1rem;">Call Notes Log</label>
      <div id="modal-call-log" class="call-log"></div>

      <!-- Add new note with its own Save button -->
      <div class="note-add-wrap">
        <div class="note-add-label">ğŸ“ Add Note From This Call</div>
        <textarea id="modal-new-note"
          placeholder="What happened in this call? Outcome, follow-up needed, customer queryâ€¦"></textarea>
        <button class="note-save-btn" id="note-save-btn" onclick="saveNote()">Save Note</button>
      </div>
    </div>

    <!-- Admin notes (contacts only) -->
    <div id="modal-adminnotes-section">
      <label>Admin Notes</label>
      <textarea id="modal-notes" placeholder="Add internal notes hereâ€¦"></textarea>
    </div>

    <div class="modal-actions">
      <button class="modal-cancel" onclick="closeModal()">Cancel</button>
      <button class="modal-save" onclick="saveEdit()">Save Changes</button>
    </div>
  </div>
</div>

<!-- â•â•â• REMINDER MODAL â•â•â• -->
<div class="modal-overlay" id="reminder-overlay" onclick="closeReminderModal(event)">
  <div class="reminder-modal">
    <h3>â° Set Reminder</h3>
    <p class="reminder-modal-sub">You'll receive an email when it's time to call this customer.</p>

    <!-- Customer summary -->
    <div class="reminder-customer" id="reminder-customer-info"></div>

    <label>Reminder Date &amp; Time *</label>
    <input type="datetime-local" id="reminder-datetime"/>
    <div style="font-size:.72rem;color:var(--muted);margin-top:.3rem;">Times are in your local timezone (IST)</div>

    <label>Note to yourself (optional)</label>
    <textarea id="reminder-note"
      placeholder="e.g. Ask about health plan for 4 members, check if they've compared other quotesâ€¦"></textarea>

    <div class="reminder-modal-actions">
      <button class="modal-cancel" onclick="closeReminderModal()">Cancel</button>
      <button class="reminder-set-btn" id="reminder-set-btn" onclick="setReminder()">â° Set Reminder</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const API = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
  ? 'http://localhost:5000/api'
  : '/api';

// â”€â”€ Department config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEPT = {
  loan:       { label:'Loans & Finance',            icon:'ğŸ ', cls:'dept-loan'       },
  health:     { label:'Health Insurance',            icon:'ğŸ¥', cls:'dept-health'     },
  life:       { label:'Life Insurance',              icon:'â¤ï¸', cls:'dept-life'       },
  bike:       { label:'Bike Insurance',              icon:'ğŸï¸', cls:'dept-bike'       },
  car:        { label:'Car Insurance',               icon:'ğŸš—', cls:'dept-car'        },
  commercial: { label:'Commercial Vehicle Insurance',icon:'ğŸš›', cls:'dept-commercial' },
};

const DETAIL_LABELS = {
  loanType:'Loan Type', loanAmount:'Loan Amount', employmentType:'Employment Type',
  monthlyIncome:'Monthly Income', existingLoans:'Existing Loans',
  coverage:'Coverage For', sumInsured:'Sum Insured', existingPolicy:'Existing Policy',
  preExisting:'Pre-existing Conditions',
  ageGroup:'Age Group', smoker:'Smoker', planType:'Plan Type',
  coverageAmount:'Coverage Amount', dependants:'Dependants',
  regNumber:'Registration No.', makeModel:'Make & Model', year:'Year',
  currentInsurer:'Current Insurer', coverageType:'Coverage Type', addOns:'Add-ons',
  vehicleType:'Vehicle Type', numberOfVehicles:'No. of Vehicles',
  goodsCarrierType:'Goods Carrier Type',
};

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let token       = localStorage.getItem('cc_token') || '';
let editType    = '';
let editId      = '';
let reminderId  = '';
let currentPage = { bookings: 1, contacts: 1 };

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('DOMContentLoaded', () => {
  updateClock();
  setInterval(updateClock, 30000);
  if (token) verifyToken();
  // Default reminder datetime to tomorrow 10 AM
  const d = new Date();
  d.setDate(d.getDate() + 1);
  d.setHours(10, 0, 0, 0);
  const local = new Date(d - d.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
  document.getElementById('reminder-datetime').value = local;
});

function updateClock() {
  document.getElementById('clock').textContent =
    new Date().toLocaleString('en-IN', {
      timeZone:'Asia/Kolkata', weekday:'short',
      day:'numeric', month:'short', hour:'2-digit', minute:'2-digit',
    });
}

// â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function verifyToken() {
  try {
    const r = await apiFetch('/auth/verify');
    if (r.success) showApp();
    else { token = ''; localStorage.removeItem('cc_token'); }
  } catch { token = ''; localStorage.removeItem('cc_token'); }
}

async function doLogin() {
  const email = document.getElementById('l-email').value.trim();
  const pass  = document.getElementById('l-pass').value;
  const errEl = document.getElementById('login-error');
  errEl.style.display = 'none';
  try {
    const r = await apiFetch('/auth/login', 'POST', { email, password: pass });
    if (r.success) {
      token = r.token;
      localStorage.setItem('cc_token', token);
      showApp();
    } else {
      errEl.textContent = r.message;
      errEl.style.display = 'block';
    }
  } catch {
    errEl.textContent = 'Login failed. Check your credentials.';
    errEl.style.display = 'block';
  }
}

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') { closeModal(); closeReminderModal(); }
  if (e.key === 'Enter' && document.getElementById('login-screen').style.display !== 'none') {
    doLogin();
  }
});

function doLogout() {
  token = '';
  localStorage.removeItem('cc_token');
  document.getElementById('app').classList.remove('show');
  document.getElementById('login-screen').style.display = 'flex';
}

function showApp() {
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('app').classList.add('show');
  loadDashboard();
}

// â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const panelTitles = {
  dashboard: 'Dashboard',
  bookings:  'Consultation Bookings',
  contacts:  'Contact Submissions',
};

function showPanel(name) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('panel-' + name).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => {
    if (n.textContent.toLowerCase().includes(name)) n.classList.add('active');
  });
  document.getElementById('panel-heading').textContent = panelTitles[name] || name;
  if (name === 'bookings') loadBookings();
  if (name === 'contacts') loadContacts();
}

// â”€â”€ API helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function apiFetch(path, method='GET', body=null) {
  const opts = {
    method,
    headers: {
      'Content-Type': 'application/json',
      ...(token ? { Authorization: 'Bearer ' + token } : {}),
    },
  };
  if (body) opts.body = JSON.stringify(body);
  const res  = await fetch(API + path, opts);
  const data = await res.json();
  if (res.status === 401 || res.status === 403) doLogout();
  return data;
}

// â”€â”€ Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadDashboard() {
  const r = await apiFetch('/admin/stats');
  if (!r.success) return;
  const s = r.stats;

  document.getElementById('stats-row').innerHTML = `
    <div class="stat-card">
      <div class="stat-label">Total Leads</div>
      <div class="stat-num">${s.totalLeads}</div>
      <div class="stat-sub">All time</div>
    </div>
    <div class="stat-card orange">
      <div class="stat-label">New Leads</div>
      <div class="stat-num">${s.newLeads}</div>
      <div class="stat-sub">Awaiting contact</div>
    </div>
    <div class="stat-card blue">
      <div class="stat-label">Bookings</div>
      <div class="stat-num">${s.totalBookings}</div>
      <div class="stat-sub">${s.newBookings} new</div>
    </div>
    <div class="stat-card green">
      <div class="stat-label">Contacts</div>
      <div class="stat-num">${s.totalContacts}</div>
      <div class="stat-sub">${s.newContacts} new</div>
    </div>`;

  const bb = document.getElementById('nav-booking-badge');
  const cb = document.getElementById('nav-contact-badge');
  bb.textContent = s.newBookings > 0 ? s.newBookings : '';
  cb.textContent = s.newContacts > 0 ? s.newContacts : '';

  const deptData = {};
  (r.bookingsByDepartment || []).forEach(d => { deptData[d._id] = d.count; });
  document.getElementById('dept-grid').innerHTML = Object.entries(DEPT).map(([key, d]) => `
    <div class="dept-tile">
      <span class="dept-tile-ico">${d.icon}</span>
      <div class="dept-tile-body">
        <div class="dept-tile-count">${deptData[key] || 0}</div>
        <div class="dept-tile-lbl">${d.label}</div>
      </div>
    </div>`).join('');

  document.getElementById('recent-bookings').innerHTML = miniBookingTable(r.recentBookings);
  document.getElementById('recent-contacts').innerHTML = miniContactTable(r.recentContacts);
}

function miniBookingTable(rows) {
  if (!rows?.length) return '<div class="empty"><div class="empty-icon">ğŸ“­</div><p>No bookings yet</p></div>';
  const items = rows.map(b => {
    const d = DEPT[b.department] || { icon:'ğŸ“‹', label: b.department };
    return `<tr>
      <td class="td-name">${esc(b.name)}</td>
      <td><span class="dept-badge ${(DEPT[b.department]||{cls:''}).cls}">${d.icon} ${d.label}</span></td>
      <td><span class="badge badge-${(b.status||'new').replace('-','')}">${b.status||'new'}</span></td>
      <td class="td-date">${fmtDate(b.createdAt)}</td>
    </tr>`;
  }).join('');
  return `<table><thead><tr><th>Name</th><th>Department</th><th>Status</th><th>Date</th></tr></thead>
    <tbody>${items}</tbody></table>`;
}

function miniContactTable(rows) {
  if (!rows?.length) return '<div class="empty"><div class="empty-icon">ğŸ“­</div><p>No contacts yet</p></div>';
  const items = rows.map(c => `<tr>
    <td class="td-name">${esc(c.firstName)} ${esc(c.lastName)}</td>
    <td><a href="tel:${c.phone}" style="color:var(--accent);font-weight:600;">${c.phone}</a></td>
    <td><span class="badge badge-${c.status||'new'}">${c.status||'new'}</span></td>
    <td class="td-date">${fmtDate(c.createdAt)}</td>
  </tr>`).join('');
  return `<table><thead><tr><th>Name</th><th>Phone</th><th>Status</th><th>Date</th></tr></thead>
    <tbody>${items}</tbody></table>`;
}

// â”€â”€ Bookings table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadBookings(page = currentPage.bookings) {
  currentPage.bookings = page;
  const search = document.getElementById('booking-search')?.value || '';
  const status = document.getElementById('booking-status')?.value || 'all';
  const dept   = document.getElementById('booking-dept')?.value   || 'all';
  const params = new URLSearchParams({ page, limit: 15, status, search, department: dept });
  const r = await apiFetch('/admin/bookings?' + params);
  if (!r.success) return;

  const tbody = document.getElementById('bookings-body');
  if (!r.data.length) {
    tbody.innerHTML = `<tr><td colspan="9"><div class="empty">
      <div class="empty-icon">ğŸ“­</div><p>No bookings found</p></div></td></tr>`;
    document.getElementById('bookings-pagination').innerHTML = '';
    return;
  }

  window._bookingMap = {};
  r.data.forEach(b => { window._bookingMap[b._id] = b; });

  tbody.innerHTML = r.data.map(b => {
    const d  = DEPT[b.department] || { icon:'ğŸ“‹', label: b.department, cls:'' };
    const cm = { 'Phone Call':'ğŸ“', 'WhatsApp':'ğŸ’¬', 'Email':'ğŸ“§' }[b.contactMethod] || 'ğŸ“';
    const slot = (b.timeSlot || '').replace(' (9 AM â€“ 12 PM)','').replace(' (12 PM â€“ 4 PM)','').replace(' (4 PM â€“ 7 PM)','');

    // Reminder state
    const hasActiveReminder = b.reminder && b.reminder.scheduledAt && !b.reminder.sent;
    const reminderChip = hasActiveReminder
      ? `<div class="reminder-chip">â° ${fmtDate(b.reminder.scheduledAt)}</div>`
      : (b.reminder && b.reminder.sent ? `<div class="reminder-chip" style="color:var(--green);">âœ… Reminder sent</div>` : '');

    return `<tr>
      <td class="td-name">${esc(b.name)}</td>
      <td class="td-phone"><a href="tel:${b.phone}">${b.phone}</a></td>
      <td><span class="dept-badge ${d.cls}">${d.icon} ${d.label}</span></td>
      <td class="td-city">${esc(b.city || 'â€”')}</td>
      <td class="cm-chip">${cm} ${esc(b.contactMethod || 'Phone Call')}</td>
      <td style="font-size:.8rem;color:var(--muted);">${esc(slot || b.timeSlot || 'â€”')}</td>
      <td><span class="badge badge-${(b.status||'new').replace('-','')}">${b.status||'new'}</span></td>
      <td class="td-date">${fmtDate(b.createdAt)}</td>
      <td>
        <div class="actions">
          <a href="tel:${b.phone}" class="act-btn act-call">ğŸ“</a>
          <a href="https://wa.me/${b.phone.replace(/\D/g,'')}" target="_blank" class="act-btn act-wa">ğŸ’¬</a>
          <button class="act-btn act-edit" onclick="openEditById('booking','${b._id}')">Edit</button>
          <button class="act-btn act-reminder${hasActiveReminder ? ' is-set' : ''}"
            onclick="openReminderModal('${b._id}')" title="${hasActiveReminder ? 'Reminder active â€” click to change' : 'Set a reminder'}">â°</button>
          <button class="act-btn act-delete" onclick="deleteLead('booking','${b._id}')">Del</button>
        </div>
        ${reminderChip}
      </td>
    </tr>`;
  }).join('');

  renderPagination('bookings-pagination', r.pagination, loadBookings);
}

// â”€â”€ Contacts table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadContacts(page = currentPage.contacts) {
  currentPage.contacts = page;
  const search = document.getElementById('contact-search')?.value || '';
  const status = document.getElementById('contact-status')?.value || 'all';
  const params = new URLSearchParams({ page, limit: 15, status, search });
  const r = await apiFetch('/admin/contacts?' + params);
  if (!r.success) return;

  const tbody = document.getElementById('contacts-body');
  if (!r.data.length) {
    tbody.innerHTML = `<tr><td colspan="7"><div class="empty">
      <div class="empty-icon">ğŸ“­</div><p>No contacts found</p></div></td></tr>`;
    document.getElementById('contacts-pagination').innerHTML = '';
    return;
  }

  window._contactMap = {};
  r.data.forEach(c => { window._contactMap[c._id] = c; });

  tbody.innerHTML = r.data.map(c => `
    <tr>
      <td class="td-name">${esc(c.firstName)} ${esc(c.lastName)}</td>
      <td class="td-phone"><a href="tel:${c.phone}">${c.phone}</a></td>
      <td style="font-size:.82rem;">${c.email ? `<a href="mailto:${c.email}">${esc(c.email)}</a>` : 'â€”'}</td>
      <td style="font-size:.82rem;">${esc(c.interest || 'â€”')}</td>
      <td><span class="badge badge-${c.status||'new'}">${c.status||'new'}</span></td>
      <td class="td-date">${fmtDate(c.createdAt)}</td>
      <td>
        <div class="actions">
          <a href="tel:${c.phone}" class="act-btn act-call">ğŸ“</a>
          <button class="act-btn act-edit" onclick="openEditById('contact','${c._id}')">Edit</button>
          <button class="act-btn act-delete" onclick="deleteLead('contact','${c._id}')">Del</button>
        </div>
      </td>
    </tr>`).join('');

  renderPagination('contacts-pagination', r.pagination, loadContacts);
}

// â”€â”€ Pagination â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPagination(containerId, pagination, loadFn) {
  const el = document.getElementById(containerId);
  if (!el || pagination.pages <= 1) { if (el) el.innerHTML = ''; return; }
  let html = `<span class="page-info">Page ${pagination.page} of ${pagination.pages} (${pagination.total} total)</span>`;
  for (let i = 1; i <= pagination.pages; i++) {
    html += `<button class="page-btn${i===pagination.page?' active':''}"
      onclick="(${loadFn.name})(${i})">${i}</button>`;
  }
  el.innerHTML = html;
}

// â”€â”€ Edit Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const bookingStatuses = ['new','confirmed','completed','cancelled','no-show'];
const contactStatuses = ['new','contacted','converted','closed'];

async function openEditById(type, id) {
  showToast('Loadingâ€¦');
  try {
    const path = type === 'booking'
      ? `/admin/bookings?page=1&limit=200&status=all`
      : `/admin/contacts?page=1&limit=200&status=all`;
    const r = await apiFetch(path);
    if (r.success) {
      const record = r.data.find(x => x._id === id);
      if (record) { openEdit(type, record); return; }
    }
  } catch(e) {}
  const cached = type === 'booking'
    ? (window._bookingMap || {})[id]
    : (window._contactMap || {})[id];
  if (!cached) { showToast('Could not load. Please refresh.', 'error'); return; }
  openEdit(type, cached);
}

function openEdit(type, data) {
  editType = type;
  editId   = data._id;
  const isBooking = type === 'booking';

  document.getElementById('modal-title').textContent =
    isBooking ? 'ğŸ“… Edit Booking' : 'ğŸ“© Edit Contact';

  // Contact info
  const name = isBooking ? data.name : `${data.firstName} ${data.lastName}`;
  document.getElementById('modal-contact-info').innerHTML = `
    <p><strong>Name:</strong> ${esc(name)}</p>
    <p><strong>Phone:</strong> <a href="tel:${data.phone}" style="color:var(--accent);font-weight:700;">${data.phone}</a></p>
    ${data.email ? `<p><strong>Email:</strong> <a href="mailto:${data.email}" style="color:var(--accent);">${esc(data.email)}</a></p>` : ''}
    ${isBooking ? `<p><strong>City:</strong> ${esc(data.city || 'â€”')}</p>` : ''}
    ${!isBooking && data.interest ? `<p><strong>Interest:</strong> ${esc(data.interest)}</p>` : ''}
    ${!isBooking && data.message  ? `<p><strong>Message:</strong> ${esc(data.message)}</p>`  : ''}
  `;

  if (isBooking) {
    // Dept details
    const dept = DEPT[data.department] || { label: data.department, icon: 'ğŸ“‹' };
    document.getElementById('modal-details-section').style.display = 'block';
    document.getElementById('modal-details-title').textContent = `${dept.icon} ${dept.label} â€” Specifics`;
    const details = data.details || {};
    const detailRows = Object.entries(details)
      .filter(([, v]) => v && v !== '')
      .map(([k, v]) => `<p><strong>${DETAIL_LABELS[k] || k}:</strong> ${esc(String(v))}</p>`)
      .join('');
    document.getElementById('modal-details-body').innerHTML =
      detailRows || '<p style="color:var(--muted);font-size:.82rem;">No specific details captured.</p>';

    // Schedule
    document.getElementById('modal-schedule-section').style.display = 'block';
    document.getElementById('modal-schedule-info').innerHTML = `
      <p><strong>Contact Via:</strong> ${esc(data.contactMethod || 'Phone Call')}</p>
      <p><strong>Best Time:</strong> ${esc(data.timeSlot || 'â€”')}</p>
      ${data.notes ? `<p><strong>Notes:</strong> ${esc(data.notes)}</p>` : ''}
    `;

    document.getElementById('modal-scheduled').value =
      data.scheduledAt ? new Date(data.scheduledAt).toISOString().slice(0,16) : '';

    // Show call log section, hide plain admin notes
    document.getElementById('modal-callnotes-section').style.display = 'block';
    document.getElementById('modal-adminnotes-section').style.display = 'none';
    document.getElementById('modal-new-note').value = '';
    renderCallLog(data.callNotes || []);

  } else {
    document.getElementById('modal-details-section').style.display = 'none';
    document.getElementById('modal-schedule-section').style.display = 'none';
    document.getElementById('modal-scheduled').value = '';
    // Show plain admin notes for contacts
    document.getElementById('modal-callnotes-section').style.display = 'none';
    document.getElementById('modal-adminnotes-section').style.display = 'block';
    document.getElementById('modal-notes').value = data.adminNotes || '';
  }

  const statuses = isBooking ? bookingStatuses : contactStatuses;
  document.getElementById('modal-status').innerHTML =
    statuses.map(s => `<option value="${s}"${s===data.status?' selected':''}>${s}</option>`).join('');

  document.getElementById('modal-overlay').classList.add('show');
}

// â”€â”€ Render call notes log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCallLog(notes) {
  const log = document.getElementById('modal-call-log');
  if (!notes || notes.length === 0) {
    log.innerHTML = '<div class="call-log-empty">No call notes yet. Add a note after each call.</div>';
    return;
  }
  // Newest first
  const sorted = [...notes].sort((a, b) => new Date(b.addedAt) - new Date(a.addedAt));
  log.innerHTML = sorted.map((n, i) => `
    <div class="call-log-entry">
      <div class="call-log-text">${esc(n.text)}</div>
      <div class="call-log-meta">
        ğŸ• ${fmtDate(n.addedAt)}
        ${i === 0 ? '<span class="call-log-latest">Latest</span>' : ''}
      </div>
    </div>`).join('');
}

function closeModal(e) {
  if (!e || e.target === document.getElementById('modal-overlay')) {
    document.getElementById('modal-overlay').classList.remove('show');
  }
}

// Save Changes â€” saves status + scheduledAt (bookings) or status + adminNotes (contacts)
async function saveEdit() {
  const status = document.getElementById('modal-status').value;
  const path   = editType === 'booking'
    ? `/admin/bookings/${editId}`
    : `/admin/contacts/${editId}`;

  const payload = { status };

  if (editType === 'booking') {
    const scheduledAt = document.getElementById('modal-scheduled').value;
    if (scheduledAt) payload.scheduledAt = scheduledAt;
  } else {
    payload.adminNotes = document.getElementById('modal-notes').value;
  }

  const r = await apiFetch(path, 'PATCH', payload);
  if (r.success) {
    closeModal();
    showToast('Updated âœ“', 'success');
    if (editType === 'booking') loadBookings();
    else loadContacts();
    loadDashboard();
  } else {
    showToast(r.message || 'Update failed', 'error');
  }
}

// â”€â”€ Save Call Note â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Posts to /api/admin/bookings/:id/note
// Stays in the modal â€” refreshes the call log live
async function saveNote() {
  const text = document.getElementById('modal-new-note').value.trim();
  if (!text) { showToast('Write something before saving.', 'error'); return; }

  const btn = document.getElementById('note-save-btn');
  btn.disabled = true;
  btn.textContent = 'Savingâ€¦';

  const r = await apiFetch(`/admin/bookings/${editId}/note`, 'POST', { text });

  btn.disabled = false;
  btn.textContent = 'Save Note';

  if (r.success) {
    // Update cache so table note counts refresh
    if (window._bookingMap?.[editId]) {
      window._bookingMap[editId].callNotes = r.data.callNotes;
    }
    // Re-render log in place â€” modal stays open
    renderCallLog(r.data.callNotes || []);
    document.getElementById('modal-new-note').value = '';
    showToast('Note saved âœ“', 'success');
    loadBookings(); // refresh table in background
  } else {
    showToast(r.message || 'Failed to save note.', 'error');
  }
}

// â”€â”€ Reminder Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openReminderModal(bookingId) {
  reminderId = bookingId;
  const b = (window._bookingMap || {})[bookingId];
  if (!b) { showToast('Could not load booking. Refresh and try again.', 'error'); return; }

  const dept = DEPT[b.department] || { icon: 'ğŸ“‹', label: b.department };
  const hasActive = b.reminder && b.reminder.scheduledAt && !b.reminder.sent;

  document.getElementById('reminder-customer-info').innerHTML = `
    <p><strong>${esc(b.name)}</strong> &nbsp;Â·&nbsp;
       <a href="tel:${b.phone}" style="color:var(--accent);font-weight:600;">${b.phone}</a></p>
    <p>${dept.icon} ${dept.label} &nbsp;Â·&nbsp; ${esc(b.city || 'â€”')}</p>
    ${hasActive
      ? `<p style="color:var(--purple);font-size:.78rem;margin-top:.3rem;">
           â° Current reminder: ${fmtDate(b.reminder.scheduledAt)} â€” setting a new one will replace it.
         </p>`
      : ''}
  `;

  // Pre-fill note if reminder exists
  document.getElementById('reminder-note').value =
    (b.reminder && b.reminder.note) ? b.reminder.note : '';

  // Pre-fill datetime if active reminder exists, else default tomorrow 10am
  if (hasActive) {
    const d = new Date(b.reminder.scheduledAt);
    document.getElementById('reminder-datetime').value =
      new Date(d - d.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
  } else {
    const d = new Date();
    d.setDate(d.getDate() + 1);
    d.setHours(10, 0, 0, 0);
    document.getElementById('reminder-datetime').value =
      new Date(d - d.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
  }

  document.getElementById('reminder-overlay').classList.add('show');
}

function closeReminderModal(e) {
  if (!e || e.target === document.getElementById('reminder-overlay')) {
    document.getElementById('reminder-overlay').classList.remove('show');
  }
}

async function setReminder() {
  const dtVal = document.getElementById('reminder-datetime').value;
  const note  = document.getElementById('reminder-note').value.trim();

  if (!dtVal) { showToast('Please pick a date and time.', 'error'); return; }

  const scheduledAt = new Date(dtVal).toISOString();
  if (new Date(dtVal) <= new Date()) {
    showToast('Reminder must be a future date and time.', 'error');
    return;
  }

  const btn = document.getElementById('reminder-set-btn');
  btn.disabled = true;
  btn.textContent = 'Settingâ€¦';

  const r = await apiFetch(`/admin/bookings/${reminderId}/reminder`, 'POST', { scheduledAt, note });

  btn.disabled = false;
  btn.textContent = 'â° Set Reminder';

  if (r.success) {
    // Update local cache so table re-renders reminder chip immediately
    if (window._bookingMap?.[reminderId]) {
      window._bookingMap[reminderId].reminder = r.data.reminder;
    }
    closeReminderModal();
    showToast('Reminder set! You\'ll get an email when it\'s due. âœ“', 'info');
    loadBookings();
  } else {
    showToast(r.message || 'Failed to set reminder.', 'error');
  }
}

// â”€â”€ Delete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function deleteLead(type, id) {
  if (!confirm('Delete this lead? This cannot be undone.')) return;
  const path = type === 'booking' ? `/admin/bookings/${id}` : `/admin/contacts/${id}`;
  const r = await apiFetch(path, 'DELETE');
  if (r.success) {
    showToast('Deleted âœ“', 'success');
    if (type === 'booking') loadBookings();
    else loadContacts();
    loadDashboard();
  } else {
    showToast('Delete failed', 'error');
  }
}

// â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg, type='') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className   = 'toast show ' + type;
  setTimeout(() => t.classList.remove('show'), 3200);
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmtDate(iso) {
  if (!iso) return 'â€”';
  return new Date(iso).toLocaleString('en-IN', {
    timeZone:'Asia/Kolkata', day:'numeric', month:'short',
    hour:'2-digit', minute:'2-digit',
  });
}

function esc(str) {
  return String(str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function debounce(fn, ms) {
  let timer;
  return (...args) => { clearTimeout(timer); timer = setTimeout(() => fn(...args), ms); };
}
</script>
</body>
</html>
